{"job":{"components":{"2004576":{"id":2004576,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":976,"y":208,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004671],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"raw_robohead_studios_project"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"raw_robohead_studios_project"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"client_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"state"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"actual_start_date"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"start_date"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"original_start_date"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"actual_completion_date"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"due_date"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"original_due_date"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"billing_type_id"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"exploration"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004577":{"id":2004577,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":335239555,"x":1424,"y":304,"width":32,"height":32,"inputConnectorIDs":[2004643],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stg1_robohead_studios_fact_financial_metrics_client_fees_service"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stg1_robohead_studios_fact_financial_metrics_client_fees_service"}}}},"visible":true},"3":{"slot":3,"name":"Table Sort Key","elements":{},"visible":true},"4":{"slot":4,"name":"Table Distribution Style","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Even"}}}},"visible":true},"5":{"slot":5,"name":"Table Distribution Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":null}}}},"visible":false},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"staging"}}}},"visible":true},"7":{"slot":7,"name":"Sort Key Options","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Compound"}}}},"visible":false}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004578":{"id":2004578,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1716658327,"x":1168,"y":304,"width":32,"height":32,"inputConnectorIDs":[2004617],"outputConnectorIDs":[2004643],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"apportion fees across projects evenly"}}}},"visible":true},"2":{"slot":2,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"3":{"slot":3,"name":"Calculations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"COUNT(\"project_id\") OVER (PARTITION BY \"client_fee_history_id\",\"bill_date\")"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id_projects"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"case\n\twhen \"client_fee_history_id_projects\" is null or \"client_fee_history_id_projects\" = 0\n    \tthen \"revenue_amount\"::numeric(38,4)\n    else \"revenue_amount\"::numeric(38,4) / \"client_fee_history_id_projects\"::numeric(38,4) \nend"},"2":{"slot":2,"type":"STRING","value":"revenue_amount"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"case\n\twhen \"client_fee_history_id_projects\" is null or \"client_fee_history_id_projects\" = 0\n    \tthen \"estimated_wip_revenue\"::numeric(38,4)\n    else \"estimated_wip_revenue\"::numeric(38,4) / \"client_fee_history_id_projects\"::numeric(38,4) \n\nend"},"2":{"slot":2,"type":"STRING","value":"estimated_wip_revenue"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"case \n\twhen client_fee_fee_type_id = 540\n    \tthen 'client_fee_history_service'\n    else 'client_fee_history_prebill'\nend"},"2":{"slot":2,"type":"STRING","value":"source_table"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004579":{"id":2004579,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":880,"y":144,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004621,2004667],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"raw_cloudwall_order_invoice"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"raw_cloudwall_order_invoice"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"order_invoice_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"order_invoice_date"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"market_id"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"exploration"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004580":{"id":2004580,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-629958239,"x":-224,"y":48,"width":32,"height":32,"inputConnectorIDs":[2004640,2004646,2004665],"outputConnectorIDs":[2004647,2004650],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Join dd attr"}}}},"visible":true},"2":{"slot":2,"name":"Main Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Monthly Recurring Fees"}}}},"visible":true},"3":{"slot":3,"name":"Main Table Alias","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph"}}}},"visible":true},"4":{"slot":4,"name":"Joins","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Get wes count per month"},"2":{"slot":2,"type":"STRING","value":"mnth"},"3":{"slot":3,"type":"STRING","value":"Left"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"Calc closing date"},"2":{"slot":2,"type":"STRING","value":"qtr"},"3":{"slot":3,"type":"STRING","value":"Left"}}}},"visible":true},"5":{"slot":5,"name":"Join Expressions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"left(\"rrsph\".\"bill_date\",7)::varchar = \"mnth\".\"fiscal_month\""},"2":{"slot":2,"type":"STRING","value":"rrsph_Left_mnth"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"\"mnth\".\"fiscal_quarter\"=\"qtr\".\"fiscal_quarter\""},"2":{"slot":2,"type":"STRING","value":"rrsph_Left_qtr"}}}},"visible":true},"6":{"slot":6,"name":"Output Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.client_fee_history_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.client_fee_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.client_id"},"2":{"slot":2,"type":"STRING","value":"client_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.fee_amount"},"2":{"slot":2,"type":"STRING","value":"amount"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.status_id"},"2":{"slot":2,"type":"STRING","value":"status_id"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.invoice_id"},"2":{"slot":2,"type":"STRING","value":"invoice_id"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.invoice_number"},"2":{"slot":2,"type":"STRING","value":"invoice_number"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"qtr.fiscal_quarter"},"2":{"slot":2,"type":"STRING","value":"fiscal_quarter"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"qtr.max_week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"last_wes"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"qtr.closing_date"},"2":{"slot":2,"type":"STRING","value":"closing_date"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"qtr.is_qtr_closed"},"2":{"slot":2,"type":"STRING","value":"is_qtr_closed"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"qtr.count_distinct_week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"no_of_weeks"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"mnth.fiscal_month"},"2":{"slot":2,"type":"STRING","value":"fiscal_month"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"mnth.count_distinct_week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"no_of_wks_month"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.frequency"},"2":{"slot":2,"type":"STRING","value":"frequency"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.recurring"},"2":{"slot":2,"type":"STRING","value":"recurring"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.client_fee_history_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_state"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.client_fee_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_state"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.resource_id"},"2":{"slot":2,"type":"STRING","value":"resource_id"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.fee_type_id"},"2":{"slot":2,"type":"STRING","value":"fee_type_id"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"rrsph.bill_date"},"2":{"slot":2,"type":"STRING","value":"bill_date"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004581":{"id":2004581,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1701703136,"x":-160,"y":256,"width":32,"height":32,"inputConnectorIDs":[2004619],"outputConnectorIDs":[2004608],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Get max wes per qtr"}}}},"visible":true},"2":{"slot":2,"name":"Groupings","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"fiscal_quarter"}}}},"visible":true},"3":{"slot":3,"name":"Aggregations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"Max"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"Count Distinct"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004582":{"id":2004582,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":-1760161015,"x":-80,"y":48,"width":32,"height":32,"inputConnectorIDs":[2004647],"outputConnectorIDs":[2004610],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Filter not closed"}}}},"visible":true},"2":{"slot":2,"name":"Filter Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"is_qtr_closed"},"2":{"slot":2,"type":"STRING","value":"Not"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"true"}}}},"visible":true},"3":{"slot":3,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AND"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004583":{"id":2004583,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-629958239,"x":320,"y":256,"width":32,"height":32,"inputConnectorIDs":[2004609,2004660],"outputConnectorIDs":[2004670],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"distribute revenue 0"}}}},"visible":true},"2":{"slot":2,"name":"Main Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"calc monthly & weekly & excess amounts"}}}},"visible":true},"3":{"slot":3,"name":"Main Table Alias","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh"}}}},"visible":true},"4":{"slot":4,"name":"Joins","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Distinct WES / month"},"2":{"slot":2,"type":"STRING","value":"qtr"},"3":{"slot":3,"type":"STRING","value":"Left"}}}},"visible":true},"5":{"slot":5,"name":"Join Expressions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"rrspfh\".\"fiscal_quarter\"=\"qtr\".\"fiscal_quarter\"\nand\n\"rrspfh\".\"fiscal_month\"=\"qtr\".\"fiscal_month\""},"2":{"slot":2,"type":"STRING","value":"rrspfh_Left_qtr"}}}},"visible":true},"6":{"slot":6,"name":"Output Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_history_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_id"},"2":{"slot":2,"type":"STRING","value":"client_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fiscal_quarter"},"2":{"slot":2,"type":"STRING","value":"fiscal_quarter"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fiscal_month"},"2":{"slot":2,"type":"STRING","value":"fiscal_month"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"qtr.week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"bill_date"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.invoice_number"},"2":{"slot":2,"type":"STRING","value":"invoice_number"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fee_amount"},"2":{"slot":2,"type":"STRING","value":"fee_amount"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.revenue_amount"},"2":{"slot":2,"type":"STRING","value":"revenue_amount"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.estimated_wip_revenue"},"2":{"slot":2,"type":"STRING","value":"estimated_wip_revenue"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.total_qtr_revenue"},"2":{"slot":2,"type":"STRING","value":"total_qtr_revenue"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.weekly_revenue_amount"},"2":{"slot":2,"type":"STRING","value":"weekly_revenue_amount"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fee_excess_amount"},"2":{"slot":2,"type":"STRING","value":"fee_excess_amount"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.frequency"},"2":{"slot":2,"type":"STRING","value":"frequency"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.recurring"},"2":{"slot":2,"type":"STRING","value":"recurring"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_history_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_state"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_state"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.invoice_id"},"2":{"slot":2,"type":"STRING","value":"invoice_id"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.status_id"},"2":{"slot":2,"type":"STRING","value":"status_id"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fee_type_id"},"2":{"slot":2,"type":"STRING","value":"fee_type_id"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.resource_id"},"2":{"slot":2,"type":"STRING","value":"resource_id"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.invoice_month"},"2":{"slot":2,"type":"STRING","value":"invoice_month"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004584":{"id":2004584,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1701703136,"x":-16,"y":112,"width":32,"height":32,"inputConnectorIDs":[2004620],"outputConnectorIDs":[2004649,2004665],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Get wes count per month"}}}},"visible":true},"2":{"slot":2,"name":"Groupings","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"fiscal_month"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"fiscal_quarter"}}}},"visible":true},"3":{"slot":3,"name":"Aggregations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"Count Distinct"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004585":{"id":2004585,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-629958239,"x":48,"y":48,"width":32,"height":32,"inputConnectorIDs":[2004610,2004611],"outputConnectorIDs":[2004613,2004656],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Join future dd attributes"}}}},"visible":true},"2":{"slot":2,"name":"Main Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Filter not closed"}}}},"visible":true},"3":{"slot":3,"name":"Main Table Alias","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh"}}}},"visible":true},"4":{"slot":4,"name":"Joins","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"build future dd attributes"},"2":{"slot":2,"type":"STRING","value":"dd"},"3":{"slot":3,"type":"STRING","value":"Left"}}}},"visible":true},"5":{"slot":5,"name":"Join Expressions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"rrspfh\".\"fiscal_month\"=\"dd\".\"fiscal_month\"\nand\n\"rrspfh\".\"fiscal_quarter\"=\"dd\".\"fiscal_quarter\"\n"},"2":{"slot":2,"type":"STRING","value":"rrspfh_Left_dd"}}}},"visible":true},"6":{"slot":6,"name":"Output Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_history_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_id"},"2":{"slot":2,"type":"STRING","value":"client_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.amount"},"2":{"slot":2,"type":"STRING","value":"amount"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.status_id"},"2":{"slot":2,"type":"STRING","value":"status_id"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.invoice_id"},"2":{"slot":2,"type":"STRING","value":"invoice_id"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.invoice_number"},"2":{"slot":2,"type":"STRING","value":"invoice_number"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fiscal_quarter"},"2":{"slot":2,"type":"STRING","value":"fiscal_quarter"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.last_wes"},"2":{"slot":2,"type":"STRING","value":"last_wes"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.closing_date"},"2":{"slot":2,"type":"STRING","value":"closing_date"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.is_qtr_closed"},"2":{"slot":2,"type":"STRING","value":"is_qtr_closed"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fiscal_month"},"2":{"slot":2,"type":"STRING","value":"fiscal_month"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.no_of_wks_month"},"2":{"slot":2,"type":"STRING","value":"no_of_wks_month"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"dd.month_rank"},"2":{"slot":2,"type":"STRING","value":"month_rank"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"dd.weeks_per_month"},"2":{"slot":2,"type":"STRING","value":"weeks_per_month"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"dd.weeks_per_qtr"},"2":{"slot":2,"type":"STRING","value":"weeks_per_qtr"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"dd.prev_weeks_qtr"},"2":{"slot":2,"type":"STRING","value":"prev_weeks_qtr"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.frequency"},"2":{"slot":2,"type":"STRING","value":"frequency"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.recurring"},"2":{"slot":2,"type":"STRING","value":"recurring"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_history_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_state"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_state"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fee_type_id"},"2":{"slot":2,"type":"STRING","value":"fee_type_id"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.resource_id"},"2":{"slot":2,"type":"STRING","value":"resource_id"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004586":{"id":2004586,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-629958239,"x":320,"y":48,"width":32,"height":32,"inputConnectorIDs":[2004645,2004664,2004668],"outputConnectorIDs":[2004612],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"assign wes"}}}},"visible":true},"2":{"slot":2,"name":"Main Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"client fee unit"}}}},"visible":true},"3":{"slot":3,"name":"Main Table Alias","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh"}}}},"visible":true},"4":{"slot":4,"name":"Joins","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"build future dd attributes"},"2":{"slot":2,"type":"STRING","value":"dd"},"3":{"slot":3,"type":"STRING","value":"Left"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"get invoice details"},"2":{"slot":2,"type":"STRING","value":"inv"},"3":{"slot":3,"type":"STRING","value":"Left"}}}},"visible":true},"5":{"slot":5,"name":"Join Expressions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"rrspfh\".\"fiscal_quarter\"=\"dd\".\"fiscal_quarter\"\nand\n\"rrspfh\".\"first_fmonth\"<=\"dd\".\"month_rank\""},"2":{"slot":2,"type":"STRING","value":"rrspfh_Left_dd"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"\"rrspfh\".\"client_id\"=\"inv\".\"client_id\"\nand\n\"rrspfh\".\"client_fee_id\"=\"inv\".\"client_fee_id\"\nand\n\"rrspfh\".\"fiscal_quarter\"=\"inv\".\"fiscal_quarter\"\nand\n\"dd\".\"fiscal_month\"=\"inv\".\"fiscal_month\""},"2":{"slot":2,"type":"STRING","value":"rrspfh_Left_inv"}}}},"visible":true},"6":{"slot":6,"name":"Output Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"inv.client_fee_history_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_id"},"2":{"slot":2,"type":"STRING","value":"client_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fiscal_quarter"},"2":{"slot":2,"type":"STRING","value":"fiscal_quarter"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fee_amount"},"2":{"slot":2,"type":"STRING","value":"fee_amount"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"inv.invoice_number"},"2":{"slot":2,"type":"STRING","value":"invoice_number"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"inv.invoice_month"},"2":{"slot":2,"type":"STRING","value":"invoice_month"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.revenue_amount"},"2":{"slot":2,"type":"STRING","value":"revenue_amount"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.weekly_revenue_amount"},"2":{"slot":2,"type":"STRING","value":"weekly_revenue_amount"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.estimated_wip_revenue"},"2":{"slot":2,"type":"STRING","value":"estimated_wip_revenue"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.total_qtr_revenue"},"2":{"slot":2,"type":"STRING","value":"total_qtr_revenue"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"dd.fiscal_month"},"2":{"slot":2,"type":"STRING","value":"fiscal_month"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"dd.month_rank"},"2":{"slot":2,"type":"STRING","value":"month_rank"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"dd.weeks_per_month"},"2":{"slot":2,"type":"STRING","value":"weeks_per_month"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"dd.weeks_per_qtr"},"2":{"slot":2,"type":"STRING","value":"weeks_per_qtr"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"dd.prev_weeks_qtr"},"2":{"slot":2,"type":"STRING","value":"prev_weeks_qtr"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"dd.frequency"},"2":{"slot":2,"type":"STRING","value":"frequency"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"dd.recurring"},"2":{"slot":2,"type":"STRING","value":"recurring"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"inv.client_fee_history_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_state"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"inv.client_fee_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_state"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"inv.invoice_id"},"2":{"slot":2,"type":"STRING","value":"invoice_id"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"inv.status_id"},"2":{"slot":2,"type":"STRING","value":"status_id"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"inv.fee_type_id"},"2":{"slot":2,"type":"STRING","value":"fee_type_id"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"inv.resource_id"},"2":{"slot":2,"type":"STRING","value":"resource_id"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"inv.order_invoice_id"},"2":{"slot":2,"type":"STRING","value":"order_invoice_id"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004587":{"id":2004587,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":784,"y":448,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004641],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_date"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_date"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"date_sk"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"calendar_date"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"week_ending_sunday"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"reporting"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004588":{"id":2004588,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-629958239,"x":608,"y":144,"width":32,"height":32,"inputConnectorIDs":[2004621,2004648],"outputConnectorIDs":[2004658],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"join oi"}}}},"visible":true},"2":{"slot":2,"name":"Main Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Unite 0"}}}},"visible":true},"3":{"slot":3,"name":"Main Table Alias","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"fees"}}}},"visible":true},"4":{"slot":4,"name":"Joins","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"raw_cloudwall_order_invoice"},"2":{"slot":2,"type":"STRING","value":"oi"},"3":{"slot":3,"type":"STRING","value":"Left"}}}},"visible":true},"5":{"slot":5,"name":"Join Expressions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"fees\".\"invoice_id\" = \"oi\".\"order_invoice_id\""},"2":{"slot":2,"type":"STRING","value":"fees_Left_oi"}}}},"visible":true},"6":{"slot":6,"name":"Output Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"fees.client_fee_history_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"fees.client_fee_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"fees.fee_type_id"},"2":{"slot":2,"type":"STRING","value":"fee_type_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"fees.bill_date"},"2":{"slot":2,"type":"STRING","value":"bill_date"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"fees.fee_amount"},"2":{"slot":2,"type":"STRING","value":"fee_amount"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"fees.client_id"},"2":{"slot":2,"type":"STRING","value":"client_id"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"fees.resource_id"},"2":{"slot":2,"type":"STRING","value":"resource_id"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"fees.status_id"},"2":{"slot":2,"type":"STRING","value":"status_id"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"fees.invoice_id"},"2":{"slot":2,"type":"STRING","value":"invoice_id"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"fees.invoice_number"},"2":{"slot":2,"type":"STRING","value":"invoice_number"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"fees.client_fee_history_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_state"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"fees.client_fee_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_state"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"fees.frequency"},"2":{"slot":2,"type":"STRING","value":"frequency"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"fees.recurring"},"2":{"slot":2,"type":"STRING","value":"recurring"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"oi.order_invoice_id"},"2":{"slot":2,"type":"STRING","value":"order_invoice_id"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004589":{"id":2004589,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-1841822228,"x":608,"y":-96,"width":32,"height":32,"inputConnectorIDs":[2004623,2004659],"outputConnectorIDs":[2004648],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Unite 0"}}}},"visible":true},"2":{"slot":2,"name":"Method","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"All Columns"}}}},"visible":true},"3":{"slot":3,"name":"Cast Types","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"4":{"slot":4,"name":"Add Source Component Column","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Remove duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004590":{"id":2004590,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":192,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2004613],"outputConnectorIDs":[2004664],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"client fee unit"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with\tcte_compute_revenue_wip\nas\n(\nselect\tbase.*\n  \t,\tcase when rcoi.order_invoice_id is not null then base.amount else 0 end\tas revenue_amount\n  \t,\tcase when rcoi.order_invoice_id is null then base.amount else 0 end\tas estimated_wip_revenue\n  \t,\trcoi.order_invoice_id\tas\tcw_order_invoice_id\nfrom\t$T{Join future dd attributes}\tbase\n  \t\tleft join exploration.raw_cloudwall_order_invoice rcoi on base.invoice_id = rcoi.order_invoice_id\n  )\n,\tcte_get_fee_unit\nas\n(\nselect\tbase.client_fee_id\n  \t,\tcount(base.client_fee_id) as client_fee_id_count\n    ,\tmax(base.client_id)\tas\tclient_id\n    ,\tmin(base.month_rank)\tas\tfirst_fmonth\n\t,\tmax(base.weeks_per_month)\tas\tweeks_per_month\n  \t,\tmax(base.weeks_per_qtr)\tas\tweeks_per_qtr\n  \t,\tmax(base.prev_weeks_qtr)\tas\tprev_weeks_qtr\n  \t,\tcase when min(base.month_rank) = 1 then max(base.weeks_per_qtr)\n  \t\t\t when min(base.month_rank) = 2 then max(base.weeks_per_qtr - base.prev_weeks_qtr)\n  \t\telse max(base.weeks_per_month) end\tas\ttotal_weeks\n  \t,\tmax(base.amount)\tas\tfee_amount\n  \t,\tmax(base.revenue_amount)\tas\trevenue_amount\n  \t,\tmax(base.estimated_wip_revenue)\tas\testimated_wip_revenue\n  \t,\tmax(base.amount)\t*\t(case when min(month_rank) = 1 then 3 when min(month_rank) = 2 then 2 else 1 end)\tas\ttotal_qtr_revenue\n  \t,\t(max(base.amount)\t*\t(case when min(month_rank) = 1 then 3 when min(month_rank) = 2 then 2 else 1 end))\n  \t\t/\t(case when min(base.month_rank) = 1 then max(base.weeks_per_qtr)\n  \t\t\t      when min(base.month_rank) = 2 then max(base.weeks_per_qtr - base.prev_weeks_qtr)\n  \t\t\t else max(base.weeks_per_month) end)\tas\tweekly_revenue_amount\n  \t,\tbase.fiscal_quarter\nfrom\tcte_compute_revenue_wip\tbase\ngroup\tby\tclient_fee_id,\tfiscal_quarter\norder\tby\tclient_fee_id,\tfiscal_quarter\n)\nselect\t*\nfrom\tcte_get_fee_unit"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004591":{"id":2004591,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":464,"y":352,"width":32,"height":32,"inputConnectorIDs":[2004663],"outputConnectorIDs":[2004661],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"distribute closed qtr invoice + wip revenue"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with cte_calc_overflows\nas (\n\tselect\tbase.client_fee_history_id\n\t\t,\tbase.client_fee_id\n\t    ,\tbase.client_id\n\t    ,\tbase.invoice_id\n\t    ,\tbase.invoice_number\n\t    ,\tbase.invoice_month\n\t    ,\tbase.fee_amount\n\t    ,\tbase.revenue_amount\n\t    ,\tbase.estimated_wip_revenue\n\t    ,\tbase.weekly_revenue_amount\n\t    ,\tbase.total_qtr_revenue\n\t    ,\tcase\n  \t\t\t\twhen lead(base.bill_date::date, 1) over (partition by base.client_fee_id, base.fiscal_quarter order by base.bill_date::date) is not null\n  \t\t\t\t\tthen lead(base.bill_date::date, 1) over (partition by base.client_fee_id, base.fiscal_quarter order by base.bill_date::date)\n\t  \t\t\telse dateadd('weeks', 1, base.bill_date::date)\n  \t\t\tend\tas bill_date\n\t  \t,\tcase\n  \t\t\t\twhen lead(base.fiscal_month, 1) over (partition by base.client_fee_id, base.fiscal_quarter order by base.bill_date::date) is not null\n  \t\t\t\t\tthen lead(base.fiscal_month, 1) over (partition by base.client_fee_id, base.fiscal_quarter order by base.bill_date::date)\n\t  \t\t\telse rdd.fiscal_month\n  \t\t\tend\tas fiscal_month\n\t  \t,\tcase\n  \t\t\t\twhen lead(base.fiscal_quarter, 1) over (partition by base.client_fee_id, base.fiscal_quarter order by base.bill_date::date) is not null\n\t\t\t\t\tthen lead(base.fiscal_quarter, 1) over (partition by base.client_fee_id, base.fiscal_quarter order by base.bill_date::date)\n\t  \t\t\telse rdd.fiscal_quarter\n\t\t\tend\tas fiscal_quarter\n\t  \t,\tbase.status_id\n\t  \t,\tbase.fee_type_id\n\t  \t,\tbase.frequency\n\t  \t,\tbase.recurring\n\t  \t,\tbase.client_fee_history_state\n  \t\t,\tbase.client_fee_state\n\t  \t,\tbase.resource_id\n\t  \t,\tbase.fee_excess_amount\n\t  \t,\trank() over (partition by base.client_fee_history_id, base.fiscal_month, base.fiscal_quarter order by base.bill_date desc) as rank_num\n\tfrom\t$T{distribute revenue 1}\tbase\n\t  \t\tleft join reporting.dim_date rdd\n  \t\t\t\ton\tdateadd('weeks',1,base.bill_date::date) = rdd.calendar_date\n)\n\n, cte_filter_overflows\nas (\n\tselect\tclient_fee_history_id\n\t\t,\tclient_fee_id\n\t    ,\tclient_id\n\t    ,\tinvoice_id\n\t    ,\tinvoice_number\n\t    ,\tinvoice_month\n\t    ,\tfee_amount\n\t    ,\tcase\n  \t\t\t\twhen invoice_id is not null\n  \t\t\t\t\tthen fee_excess_amount\n  \t\t\t\telse 0\n  \t\t\tend as revenue_amount\n\t    ,\tcase\n  \t\t\t\twhen invoice_id is null\n  \t\t\t\t\tthen fee_excess_amount\n  \t\t\t\telse 0\n  \t\t\tend as estimated_wip_revenue\n\t    ,\ttotal_qtr_revenue\n\t  \t,\tweekly_revenue_amount\n\t  \t,\tbill_date\n\t  \t,\tfiscal_month\n\t  \t,\tfiscal_quarter\n\t  \t,\tstatus_id\n\t  \t,\tfee_type_id\n\t  \t,\tfrequency\n\t  \t,\trecurring\n\t  \t,\tclient_fee_history_state\n  \t\t,\tclient_fee_state\n\t  \t,\tresource_id  \t\n\tfrom\tcte_calc_overflows\n\twhere\trank_num\t=\t1\n  \tand\t\tfee_excess_amount <> 0\n)\n\n, cte_union\nas (\n\tselect\tclient_fee_history_id\n\t     ,\tclient_fee_id\n\t     ,\tclient_id\n\t     ,\tinvoice_id\n\t     ,\tinvoice_number\n\t\t ,\tinvoice_month\n\t     ,\tfee_amount\n\t     ,\trevenue_amount\n\t     ,\testimated_wip_revenue\n\t     ,\ttotal_qtr_revenue\n\t\t ,\tweekly_revenue_amount\n\t\t ,\tbill_date\n\t     ,\tfiscal_month\n\t     ,\tfiscal_quarter\n\t     ,\tstatus_id\n\t     ,\tfee_type_id\n\t     ,\tfrequency\n\t     ,\trecurring\n\t     ,\tclient_fee_history_state\n  \t\t ,\tclient_fee_state\n\t     ,\tresource_id\n\t\t ,\ttrue\tas\tis_overflow\n\tfrom\tcte_filter_overflows\n\tunion\tall\n\tselect\tclient_fee_history_id\n\t     ,\tclient_fee_id\n\t     ,\tclient_id\n\t     ,\tinvoice_id\n\t     ,\tinvoice_number\n\t\t ,\tinvoice_month\n\t     ,\tfee_amount\n\t     ,\tcase\n\t\t\t\t\twhen invoice_id is not null\n\t\t\t\t\t\tthen weekly_revenue_amount\n\t\t\t\t\telse 0\n\t\t\t\tend as revenue_amount\n\t     ,\tcase\n\t\t\t\t\twhen invoice_id is null\n\t\t\t\t\t\tthen weekly_revenue_amount\n\t\t\t\t\telse 0\n\t\t\t\tend as estimated_wip_revenue\n\t     ,\ttotal_qtr_revenue\n\t\t ,\tweekly_revenue_amount\n\t\t ,\tbill_date\n\t     ,\tfiscal_month\n\t     ,\tfiscal_quarter\n\t     ,\tstatus_id\n\t     ,\tfee_type_id\n\t     ,\tfrequency\n\t     ,\trecurring\n\t     ,\tclient_fee_history_state\n  \t\t ,\tclient_fee_state\n\t     ,\tresource_id\n\t\t ,\tfalse\tas\tis_overflow\n\tfrom\t$T{distribute revenue 1}\n  \torder\tby\tbill_date,client_fee_history_id\n)\n\n, cte_flag_overrides\nas (\n\tselect\t*\n\t  \t,\tcase when max(case when is_overflow = true then 1 else 0 end) over (partition by client_fee_id, bill_date, fiscal_month) > 0 then true else false end as is_override\n\tfrom\tcte_union\n\torder\tby\tbill_date,client_fee_history_id\n)\n\n, cte_windowcalc_rows_with_overflows\nas (\n\tselect\tclient_fee_history_id\n\t\t,\tclient_fee_id\n\t\t,\tclient_id\n\t    ,\tinvoice_id\n\t\t,\tinvoice_number\n  \t\t,\tinvoice_month\n\t    ,\tfee_amount\n\t    ,\tcase\n\t\t\t\twhen is_overflow = false and is_override = true and revenue_amount <> 0\n\t  \t\t\t\tthen revenue_amount - (lag(revenue_amount)over(partition by client_fee_id,bill_date order by client_fee_history_id) + lag(estimated_wip_revenue)over(partition by client_fee_id,bill_date order by client_fee_history_id))\n\t  \t\t\telse revenue_amount\n\t  \t\tend as revenue_amount\n\t    ,\tcase\n\t\t\t\twhen is_overflow = false and is_override = true and estimated_wip_revenue <> 0\n\t  \t\t\t\tthen estimated_wip_revenue - (lag(revenue_amount)over(partition by client_fee_id,bill_date order by client_fee_history_id) + lag(estimated_wip_revenue)over(partition by client_fee_id,bill_date order by client_fee_history_id))\n\t  \t\t\telse estimated_wip_revenue\n\t  \t\tend as estimated_wip_revenue\n\t  \t,\ttotal_qtr_revenue\n\t  \t,\tweekly_revenue_amount\n\t    ,\tclient_fee_history_state\n  \t\t,\tclient_fee_state\n\t\t,\tstatus_id\n\t\t,\tfee_type_id\n\t\t,\tresource_id\n\t    ,\tbill_date\n\t    ,\tfiscal_month\n\t    ,\tfiscal_quarter\n\t    ,\tfrequency\n\t\t,\trecurring\n\t  \t,\tis_overflow\n\t  \t,\tis_override\n\tfrom\tcte_flag_overrides  \n\torder by bill_date,client_fee_history_id\n)\n\n, cte_src_attributes\nas (\n\tselect\n\t\t\tcfh.client_fee_id\n\t\t,\tcfh.fee_type_id\n\t\t,\tcfh.resource_id\n\t\t,\trank()over(partition by client_fee_id order by cfh.bill_date desc) as rank_num\n\tfrom exploration.raw_robohead_studios_client_fee_history cfh\n\t\tinner join exploration.raw_robohead_studios_client_fee cf\n\t    \ton cf.id = cfh.client_fee_id\n\t        and cfh.fee_type_id in (540,542)\n\twhere cf.state <> 2 and cfh.state <> 2\n)\n\n, cte_latest_src_attributes\nas (\n\tselect\n\t\t\tclient_fee_id\n\t\t,\tfee_type_id\n\t\t,\tresource_id\n  \tfrom cte_src_attributes\n  \twhere rank_num = 1\n)\n\n, cte_output\nas (\n\tselect\tcte_fees.client_fee_history_id\n\t\t,\tcte_fees.client_fee_id\n\t\t,\tcte_fees.client_id\n\t    ,\tcte_fees.invoice_id\n\t\t,\tcte_fees.invoice_number\n\t    ,\tcte_fees.invoice_month\n\t    ,\tcte_fees.fee_amount\n\t    ,\tcte_fees.revenue_amount\n\t    ,\tcte_fees.estimated_wip_revenue\n\t    ,\tcte_fees.bill_date\n\t    ,\tcte_fees.fiscal_month\n\t    ,\tcte_fees.fiscal_quarter\n\t\t,\tcte_fees.status_id\n\t\t,\tcoalesce(cte_fees.fee_type_id,cte_attr.fee_type_id) as fee_type_id\n\t    ,\tcte_fees.frequency\n\t\t,\tcte_fees.recurring\n\t    ,\tcte_fees.client_fee_history_state\n  \t\t,\tcte_fees.client_fee_state\n\t\t,\tcoalesce(cte_fees.resource_id,cte_attr.resource_id) as resource_id\n\tfrom\tcte_windowcalc_rows_with_overflows cte_fees\n  \t\tleft join cte_latest_src_attributes cte_attr\n  \t\t\ton cte_fees.client_fee_id = cte_attr.client_fee_id\n)\n\nselect\tclient_fee_history_id\n\t,\tclient_fee_id\n\t,\tclient_id\n    ,\tinvoice_id\n\t,\tinvoice_number\n    ,\tinvoice_month\n    ,\tfee_amount\n    ,\trevenue_amount\n    ,\testimated_wip_revenue\n    ,\tbill_date\n    ,\tfiscal_month\n    ,\tfiscal_quarter\n\t,\tstatus_id\n\t,\tfee_type_id\n    ,\tfrequency\n\t,\trecurring\n    ,\tclient_fee_history_state\n    ,\tclient_fee_state\n\t,\tresource_id\nfrom\tcte_output\norder\tby\tbill_date,client_fee_history_id"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004592":{"id":2004592,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":464,"y":256,"width":32,"height":32,"inputConnectorIDs":[2004670],"outputConnectorIDs":[2004644],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"distribute open qtr invoice + wip revenue"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with cte_calculate_new_lines\nas (\n\tselect\tbase.client_fee_history_id\n\t\t,\tbase.client_fee_id\n\t\t,\tbase.client_id\n\t\t,\tbase.invoice_id\n\t\t,\tbase.invoice_number\n  \t\t,\tbase.invoice_month\n\t\t,\tbase.fee_amount\n\t\t,\tbase.revenue_amount\n\t\t,\tbase.estimated_wip_revenue\n\t\t,\tbase.total_qtr_revenue\n\t\t,\tbase.weekly_revenue_amount\n\t\t,\tbase.fee_excess_amount\n\t\t,\tbase.client_fee_history_state\n  \t\t,\tbase.client_fee_state\n\t\t,\tbase.status_id\n\t\t,\tbase.fee_type_id\n\t\t,\tbase.resource_id\n\t\t,\tlead(base.bill_date::date, 1) over (partition by base.client_fee_id, base.fiscal_quarter order by base.bill_date::date)\tas bill_date\n\t\t,\tlead(base.fiscal_month, 1) \t  over (partition by base.client_fee_id, base.fiscal_quarter order by base.bill_date::date) as fiscal_month\n\t\t,\tlead(base.fiscal_quarter, 1)  over (partition by base.client_fee_id, base.fiscal_quarter order by base.bill_date::date) as fiscal_quarter\n\t\t,\tfrequency\n\t\t,\trecurring\n\t\t,\trank() over (partition by base.client_fee_history_id, base.client_fee_id, base.fiscal_month, base.fiscal_quarter order by base.bill_date desc) as rank_num\n\tfrom\t$T{distribute revenue 0} base\n)\n\n, cte_get_overflows\nas (\n\tselect\tclient_fee_history_id\n\t\t,\tclient_fee_id\n\t\t,\tclient_id\n\t\t,\tinvoice_id\n\t\t,\tinvoice_number\n  \t\t,\tinvoice_month\n\t\t,\tfee_amount\n\t\t,\tcase when invoice_id is not null then fee_excess_amount else 0 end as revenue_amount\n\t\t,\tcase when invoice_id is null \t then fee_excess_amount else 0 end as estimated_wip_revenue\n\t\t,\ttotal_qtr_revenue\n\t\t,\tweekly_revenue_amount\n\t\t,\tfee_excess_amount\n\t\t,\tclient_fee_history_state\n  \t\t,\tclient_fee_state\n\t\t,\tstatus_id\n\t\t,\tfee_type_id\n\t\t,\tresource_id\n\t\t,\tbill_date\n\t\t,\tfiscal_month\n\t\t,\tfiscal_quarter\n\t\t,\tfrequency\n\t\t,\trecurring\n\tfrom\tcte_calculate_new_lines\n\twhere\trank_num = 1 and bill_date is not null and client_fee_history_id is not null\n)\n\n, cte_union\nas (\n\tselect\tclient_fee_history_id\n\t\t,\tclient_fee_id\n\t\t,\tclient_id\n\t    ,\tinvoice_id\n\t\t,\tinvoice_number\n  \t\t,\tinvoice_month\n\t    ,\tfee_amount\n\t    ,\trevenue_amount\n\t    ,\testimated_wip_revenue\n\t\t,\ttotal_qtr_revenue\n\t    ,\tweekly_revenue_amount\n\t    ,\tclient_fee_history_state\n  \t\t,\tclient_fee_state\n\t\t,\tstatus_id\n\t\t,\tfee_type_id\n\t\t,\tresource_id\n\t    ,\tbill_date\n\t    ,\tfiscal_month\n\t    ,\tfiscal_quarter\n\t    ,\tfrequency\n\t\t,\trecurring\n\t  \t,\ttrue as is_overflow\n\tfrom\tcte_get_overflows\n\tunion\tall\n\tselect\tclient_fee_history_id\n\t\t,\tclient_fee_id\n\t\t,\tclient_id\n\t    ,\tinvoice_id\n\t\t,\tinvoice_number\n  \t\t,\tinvoice_month\n\t    ,\tfee_amount\n\t    ,\tcase when invoice_id is not null then weekly_revenue_amount else 0 end as revenue_amount\n\t    ,\tcase when invoice_id is null then weekly_revenue_amount else 0 end as estimated_wip_revenue\n\t\t,\ttotal_qtr_revenue\n\t  \t,\tweekly_revenue_amount\n\t    ,\tclient_fee_history_state\n  \t\t,\tclient_fee_state\n\t\t,\tstatus_id\n\t\t,\tfee_type_id\n\t\t,\tresource_id\n\t    ,\tbill_date\n\t    ,\tfiscal_month\n\t    ,\tfiscal_quarter\n\t    ,\tfrequency\n\t\t,\trecurring\n\t  \t,\tfalse as is_overflow\n\tfrom\t$T{distribute revenue 0}\n\torder\tby\tbill_date\n)\n\n, cte_flag_overrides\nas (\n\tselect\t*\n\t\t,\tcase when max(case when is_overflow = true then 1 else 0 end) over (partition by client_fee_id,\tbill_date, fiscal_month) > 0 then true else false end\tas\tis_override\n\tfrom\tcte_union\n\torder by bill_date\n)\n\n, cte_windowcalc_rows_with_overflows\nas (\n\tselect\tclient_fee_history_id\n\t\t,\tclient_fee_id\n\t\t,\tclient_id\n\t    ,\tinvoice_id\n\t\t,\tinvoice_number\n  \t\t,\tinvoice_month\n\t    ,\tfee_amount\n\t    ,\tcase\n\t\t\t\twhen is_overflow = false and is_override = true and revenue_amount <> 0\n\t  \t\t\t\tthen revenue_amount - (lag(revenue_amount)over(partition by client_fee_id,bill_date order by client_fee_history_id) + lag(estimated_wip_revenue)over(partition by client_fee_id,bill_date order by client_fee_history_id))\n\t  \t\t\telse revenue_amount\n\t  \t\tend as revenue_amount\n\t    ,\tcase\n\t\t\t\twhen is_overflow = false and is_override = true and estimated_wip_revenue <> 0\n\t  \t\t\t\tthen estimated_wip_revenue - (lag(revenue_amount)over(partition by client_fee_id,bill_date order by client_fee_history_id) + lag(estimated_wip_revenue)over(partition by client_fee_id,bill_date order by client_fee_history_id))\n\t  \t\t\telse estimated_wip_revenue\n\t  \t\tend as estimated_wip_revenue\n\t  \t,\ttotal_qtr_revenue\n\t  \t,\tweekly_revenue_amount\n\t    ,\tclient_fee_history_state\n  \t\t,\tclient_fee_state\n\t\t,\tstatus_id\n\t\t,\tfee_type_id\n\t\t,\tresource_id\n\t    ,\tbill_date\n\t    ,\tfiscal_month\n\t    ,\tfiscal_quarter\n\t    ,\tfrequency\n\t\t,\trecurring\n\t  \t,\tis_overflow\n\t  \t,\tis_override\n\tfrom\tcte_flag_overrides  \n\torder by bill_date,client_fee_history_id\n)\n\n, cte_src_attributes\nas (\n\tselect\n\t\t\tcfh.client_fee_id\n\t\t,\tcfh.fee_type_id\n\t\t,\tcfh.resource_id\n\t\t,\trank()over(partition by client_fee_id order by cfh.bill_date desc) as rank_num\n\tfrom exploration.raw_robohead_studios_client_fee_history cfh\n\t\tinner join exploration.raw_robohead_studios_client_fee cf\n\t    \ton cf.id = cfh.client_fee_id\n\t        and cfh.fee_type_id in (540,542)\n\twhere cf.state <> 2 and cfh.state <> 2\n)\n\n, cte_latest_src_attributes\nas (\n\tselect\n\t\t\tclient_fee_id\n\t\t,\tfee_type_id\n\t\t,\tresource_id\n  \tfrom cte_src_attributes\n  \twhere rank_num = 1\n)\n\n, cte_output\nas (\n\tselect\tcte_fees.client_fee_history_id\n\t\t,\tcte_fees.client_fee_id\n\t\t,\tcte_fees.client_id\n\t    ,\tcte_fees.invoice_id\n\t\t,\tcte_fees.invoice_number\n\t    ,\tcte_fees.invoice_month\n\t    ,\tcte_fees.fee_amount\n\t    ,\tcte_fees.revenue_amount\n\t    ,\tcte_fees.estimated_wip_revenue\n\t    ,\tcte_fees.bill_date\n\t    ,\tcte_fees.fiscal_month\n\t    ,\tcte_fees.fiscal_quarter\n\t\t,\tcte_fees.status_id\n\t\t,\tcoalesce(cte_fees.fee_type_id,cte_attr.fee_type_id) as fee_type_id\n\t    ,\tcte_fees.frequency\n\t\t,\tcte_fees.recurring\n\t    ,\tcte_fees.client_fee_history_state\n  \t\t,\tcte_fees.client_fee_state\n\t\t,\tcoalesce(cte_fees.resource_id,cte_attr.resource_id) as resource_id\n\tfrom\tcte_windowcalc_rows_with_overflows cte_fees\n  \t\tleft join cte_latest_src_attributes cte_attr\n  \t\t\ton cte_fees.client_fee_id = cte_attr.client_fee_id\n)\n\nselect\tclient_fee_history_id\n\t,\tclient_fee_id\n\t,\tclient_id\n    ,\tinvoice_id\n\t,\tinvoice_number\n    ,\tinvoice_month\n    ,\tfee_amount\n    ,\trevenue_amount\n    ,\testimated_wip_revenue\n    ,\tbill_date\n    ,\tfiscal_month\n    ,\tfiscal_quarter\n\t,\tstatus_id\n\t,\tfee_type_id\n    ,\tfrequency\n\t,\trecurring\n    ,\tclient_fee_history_state\n    ,\tclient_fee_state\n\t,\tresource_id\nfrom\tcte_output\norder\tby\tbill_date,client_fee_history_id"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004593":{"id":2004593,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":320,"y":144,"width":32,"height":32,"inputConnectorIDs":[2004612],"outputConnectorIDs":[2004660],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"calc monthly & weekly & excess amounts"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with cte_base_open_qtr\nas (\n\tselect\tclient_fee_history_id\n\t\t,\tclient_fee_id\n\t\t,\tclient_id\n\t\t,\tfiscal_quarter\n\t\t,\tfee_amount\n\t\t,\tcase when invoice_month = fiscal_month then invoice_number else null end as invoice_number\n\t    ,\tinvoice_month\n\t\t,\tcase when order_invoice_id is null then 0 else revenue_amount end as revenue_amount\n\t\t,\tcase when order_invoice_id is null then \n\t  \t\t\t\tcase when nvl(estimated_wip_revenue, 0) = 0 then revenue_amount else estimated_wip_revenue end\n\t  \t\telse 0 end as estimated_wip_revenue\n\t  \t,   total_qtr_revenue\n\t    ,\tweekly_revenue_amount\n\t\t,\tfiscal_month\n\t\t,\tmonth_rank\n\t\t,\tweeks_per_month\n\t\t,\tweeks_per_qtr\n\t\t,\tprev_weeks_qtr\n\t\t,\tfrequency\n\t\t,\trecurring\n\t\t,\tclient_fee_history_state\n  \t\t,\tclient_fee_state\n\t\t,\tinvoice_id\n\t  \t,\torder_invoice_id\n\t\t,\tstatus_id\n\t\t,\tfee_type_id\n\t\t,\tresource_id\n\tfrom\t$T{assign wes}\n  ) \n\n, cte_fee_excess_calc_1\nas (\n\tselect\t*\n\t  \t,\tweekly_revenue_amount * weeks_per_month\tas\tcalc_monthly_revenue\n\t  \t,\tcase\n\t  \t\t\twhen abs(fee_amount) > (abs(weekly_revenue_amount) * weeks_per_month)\n\t  \t\t\t\tthen fee_amount - (weekly_revenue_amount * weeks_per_month)\n\t  \t\telse 0 \n\t  \t\tend as fee_excess\n\tfrom\tcte_base_open_qtr\n)\n\n, cte_fee_excess_calc_2\nas (\n\tselect\t*\n  \t\t,\tfee_amount + coalesce(lag(fee_excess, 1) over (partition by client_fee_id,fiscal_quarter order by month_rank),0) - calc_monthly_revenue as calc_fee_excess\n\tfrom\tcte_fee_excess_calc_1\n\n)\n\n, cte_fee_overflow\nas (\n\tselect\t*\n  \t\t,\tcase\n  \t\t\t\twhen abs(fee_amount + coalesce(lag(calc_fee_excess, 1) over (partition by client_fee_id,fiscal_quarter order by month_rank),0) - calc_monthly_revenue) > 1\n  \t\t\t\t\tthen fee_amount + coalesce(lag(calc_fee_excess, 1) over (partition by client_fee_id,fiscal_quarter order by month_rank),0) - calc_monthly_revenue\n  \t\t\t\telse 0\n  \t\t\tend as fee_excess_amount\n\tfrom\tcte_fee_excess_calc_2\n\n)\n\nselect\n\t\tclient_fee_history_id\n\t,\tclient_fee_id\n\t,\tclient_id\n\t,\tfiscal_quarter\n\t,\tfee_amount\n\t,\tinvoice_number\n\t,\tinvoice_month\n\t,\trevenue_amount\n\t,\testimated_wip_revenue\n\t,   total_qtr_revenue\n\t,\tweekly_revenue_amount\n\t,\tfiscal_month\n\t,\tmonth_rank\n\t,\tweeks_per_month\n\t,\tweeks_per_qtr\n\t,\tprev_weeks_qtr\n\t,\tfrequency\n\t,\trecurring\n\t,\tclient_fee_history_state\n    ,\tclient_fee_state\n\t,\tinvoice_id\n\t,\torder_invoice_id\n\t,\tstatus_id\n\t,\tfee_type_id\n\t,\tresource_id\n    ,\tcalc_monthly_revenue\n    ,\tfee_excess_amount\nfrom\tcte_fee_overflow\norder\tby\tmonth_rank"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004594":{"id":2004594,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":912,"y":448,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004606],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_client"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_client"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"client_sk"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"source_system_sk"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"source_client_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"client_currency_sk"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"current_record_ind"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"reporting"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004595":{"id":2004595,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":1056,"y":448,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004669],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_currency"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_currency"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"currency_sk"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"currency_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"exchange_rate_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"exchange_rate"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"reporting"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004596":{"id":2004596,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":144,"y":-96,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004604,2004657,2004662],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"raw_robohead_studios_client_fee_history - service"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select \n\t\tcfh.id as client_fee_history_id\n\t,\tcfh.client_fee_id\n\t,\tcfh.fee_type_id\n\t,\tcfh.created_on\n\t,\tcfh.bill_date\n\t,\tcfh.amount as fee_amount\n\t,\tcfh.client_id\n\t,\tcfh.resource_id\n\t,\tcfh.status_id\n\t,\tcfh.invoice_id\n\t,\tcfh.invoice_number\n\t,\tcfh.state as client_fee_history_state\n\t,\tcf.frequency\n\t,\tcf.recurring\n    ,\tcf.state as client_fee_state\nfrom exploration.raw_robohead_studios_client_fee_history cfh\n\tinner join exploration.raw_robohead_studios_client_fee cf\n    \ton cf.id = cfh.client_fee_id\n        and cfh.fee_type_id in (540,542)\nwhere cf.state <> 2 and cfh.state <> 2"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004597":{"id":2004597,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":-1760161015,"x":400,"y":-64,"width":32,"height":32,"inputConnectorIDs":[2004662],"outputConnectorIDs":[2004623],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Monthly Non-Recurring Fees"}}}},"visible":true},"2":{"slot":2,"name":"Filter Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"frequency"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"546"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"recurring"},"2":{"slot":2,"type":"STRING","value":"Not"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"1"}}}},"visible":true},"3":{"slot":3,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AND"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004599":{"id":2004599,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1716658327,"x":608,"y":224,"width":32,"height":32,"inputConnectorIDs":[2004658],"outputConnectorIDs":[2004666],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"revenue splits"}}}},"visible":true},"2":{"slot":2,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"3":{"slot":3,"name":"Calculations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"case\n\twhen \"order_invoice_id\" is not null\n    \tthen \"fee_amount\"\n    else 0\nend::numeric(38,4)"},"2":{"slot":2,"type":"STRING","value":"revenue_amount"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"case\n\twhen \"order_invoice_id\" is null\n    \tthen \"fee_amount\"\n    else 0\nend::numeric(38,4)"},"2":{"slot":2,"type":"STRING","value":"estimated_wip_revenue"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004622":{"id":2004622,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-629958239,"x":192,"y":352,"width":32,"height":32,"inputConnectorIDs":[2004616,2004642],"outputConnectorIDs":[2004663],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"distribute revenue 1"}}}},"visible":true},"2":{"slot":2,"name":"Main Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"revenue  & estimated wip calc"}}}},"visible":true},"3":{"slot":3,"name":"Main Table Alias","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh"}}}},"visible":true},"4":{"slot":4,"name":"Joins","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Distinct WES / month"},"2":{"slot":2,"type":"STRING","value":"mnth"},"3":{"slot":3,"type":"STRING","value":"Left"}}}},"visible":true},"5":{"slot":5,"name":"Join Expressions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"rrspfh\".\"fiscal_quarter\"=\"mnth\".\"fiscal_quarter\"\nand\n\"rrspfh\".\"fiscal_month\"=\"mnth\".\"fiscal_month\""},"2":{"slot":2,"type":"STRING","value":"rrspfh_Left_mnth"}}}},"visible":true},"6":{"slot":6,"name":"Output Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_history_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_id"},"2":{"slot":2,"type":"STRING","value":"client_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"mnth.fiscal_quarter"},"2":{"slot":2,"type":"STRING","value":"fiscal_quarter"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"mnth.fiscal_month"},"2":{"slot":2,"type":"STRING","value":"fiscal_month"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.invoice_number"},"2":{"slot":2,"type":"STRING","value":"invoice_number"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.invoice_month"},"2":{"slot":2,"type":"STRING","value":"invoice_month"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"mnth.week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"bill_date"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fee_amount"},"2":{"slot":2,"type":"STRING","value":"fee_amount"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.revenue_amount"},"2":{"slot":2,"type":"STRING","value":"revenue_amount"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.total_qtr_revenue"},"2":{"slot":2,"type":"STRING","value":"total_qtr_revenue"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.weekly_revenue_amount"},"2":{"slot":2,"type":"STRING","value":"weekly_revenue_amount"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fee_excess_amount"},"2":{"slot":2,"type":"STRING","value":"fee_excess_amount"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.estimated_wip_revenue"},"2":{"slot":2,"type":"STRING","value":"estimated_wip_revenue"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.frequency"},"2":{"slot":2,"type":"STRING","value":"frequency"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.recurring"},"2":{"slot":2,"type":"STRING","value":"recurring"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_history_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_state"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.client_fee_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_state"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.invoice_id"},"2":{"slot":2,"type":"STRING","value":"invoice_id"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.status_id"},"2":{"slot":2,"type":"STRING","value":"status_id"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.fee_type_id"},"2":{"slot":2,"type":"STRING","value":"fee_type_id"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"rrspfh.resource_id"},"2":{"slot":2,"type":"STRING","value":"resource_id"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004624":{"id":2004624,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1744268877,"x":192,"y":256,"width":32,"height":32,"inputConnectorIDs":[2004618],"outputConnectorIDs":[2004609,2004642],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Distinct WES / month"}}}},"visible":true},"2":{"slot":2,"name":"Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"week_ending_sunday"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"fiscal_month"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"fiscal_quarter"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004625":{"id":2004625,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":128170095,"x":720,"y":304,"width":32,"height":32,"inputConnectorIDs":[2004607],"outputConnectorIDs":[2004602],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Rename 0"}}}},"visible":true},"2":{"slot":2,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"client_fee_history_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"client_fee_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"fee_type_id"},"2":{"slot":2,"type":"STRING","value":"fee_type_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"bill_date"},"2":{"slot":2,"type":"STRING","value":"bill_date"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"revenue_amount"},"2":{"slot":2,"type":"STRING","value":"revenue_amount"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"estimated_wip_revenue"},"2":{"slot":2,"type":"STRING","value":"estimated_wip_revenue"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"client_id"},"2":{"slot":2,"type":"STRING","value":"client_id"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"resource_id"},"2":{"slot":2,"type":"STRING","value":"resource_id"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"status_id"},"2":{"slot":2,"type":"STRING","value":"status_id"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"invoice_id"},"2":{"slot":2,"type":"STRING","value":"invoice_id"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"invoice_number"},"2":{"slot":2,"type":"STRING","value":"invoice_number"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"client_fee_history_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_state"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"client_fee_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_state"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"frequency"},"2":{"slot":2,"type":"STRING","value":"frequency"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"recurring"},"2":{"slot":2,"type":"STRING","value":"recurring"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"fiscal_month"},"2":{"slot":2,"type":"STRING","value":"fiscal_month"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"fiscal_quarter"},"2":{"slot":2,"type":"STRING","value":"fiscal_quarter"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"fee_amount"},"2":{"slot":2,"type":"STRING","value":"fee_amount"}}}},"visible":true},"3":{"slot":3,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004626":{"id":2004626,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":192,"y":112,"width":32,"height":32,"inputConnectorIDs":[2004649],"outputConnectorIDs":[2004611,2004645],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"build future dd attributes"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with cte_month_statistics\n    as (select fiscal_month\n             , fiscal_quarter\n             , rank() over (partition by fiscal_quarter order by fiscal_month) as month_rank\n             , count_distinct_week_ending_sunday\tas\tweeks_per_month\n\n             , sum(weeks_per_month) over (partition by fiscal_quarter)\tas\tweeks_per_qtr\n        from $T{Get wes count per month})\n   , cte_additional_month_stats\n    as (select *\n             , case when month_rank != 1 then lag(weeks_per_month, 1) over (order by fiscal_month, fiscal_quarter) else 0 end   as  prev_weeks_qtr\n        from cte_month_statistics)\nselect *\n\t,\t546\tas\tfrequency\n    ,\t1\tas\trecurring\nfrom cte_additional_month_stats\norder by fiscal_month"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004627":{"id":2004627,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":192,"y":48,"width":32,"height":32,"inputConnectorIDs":[2004656],"outputConnectorIDs":[2004668],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"get invoice details"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select\t\n    \tbase.client_fee_history_id\n    ,\tbase.client_fee_id\n    ,\tbase.status_id\n    ,\tbase.fee_type_id\n  \t,\tmax(base.client_id)\tas\tclient_id\n    ,\tmax(base.invoice_id)\tas\tinvoice_id\n    ,\tbase.invoice_number\n    ,\tcase when rcoi.order_invoice_id is not null then base.fiscal_month else null end\tas\tinvoice_month  \t\n    ,\tbase.fiscal_month\n    ,\tbase.fiscal_quarter\n  \t,\trcoi.order_invoice_id\n    ,\tbase.client_fee_history_state\n    ,\tbase.client_fee_state\n    ,\tmax(base.resource_id)\tas\tresource_id\nfrom\t$T{Join future dd attributes} base\n  \t\tleft join exploration.raw_cloudwall_order_invoice rcoi on base.invoice_id = rcoi.order_invoice_id\ngroup by base.client_fee_history_id,base.client_fee_id, base.invoice_number, base.status_id, base.fee_type_id, base.fiscal_month, base.fiscal_quarter, rcoi.order_invoice_id,base.client_fee_history_state,base.client_fee_state\norder\tby\tbase.client_fee_id, base.invoice_number, base.fiscal_month, base.fiscal_quarter"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004628":{"id":2004628,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-16,"y":352,"width":32,"height":32,"inputConnectorIDs":[2004615],"outputConnectorIDs":[2004616],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"revenue  & estimated wip calc"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with cte_monthly\nas (\n\tselect\tbase.client_fee_history_id\n\t  \t,\tbase.client_fee_id\n\t  \t,\tbase.invoice_number\n\t  \t,\tbase.fiscal_month\tas\tinvoice_month\n\t  \t,\tcount(base.client_fee_id) over (partition by base.client_fee_id, base.fiscal_quarter) as client_fee_id_count\n\t  \t,\tbase.client_id\n\t  \t,\tbase.amount\tas\tfee_amount  \t\n\t  \t,\tcase when rcoi.order_invoice_id is not null then base.amount else 0 end\tas revenue_amount\n\t  \t,\tcase when rcoi.order_invoice_id is null then base.amount else 0 end\tas estimated_wip_revenue\n\t  \t,\tsum(base.amount) over (partition by base.client_fee_id, base.fiscal_quarter) as total_qtr_revenue\n\t  \t,\tbase.no_of_wks_month as weeks_month\n\t  \t,\tcase\n  \t\t\t\twhen count(base.client_fee_id) over (partition by base.client_fee_id, base.fiscal_quarter) = 3\n  \t\t\t\t\tthen max(base.no_of_weeks)\n\t  \t\t\telse sum(max(base.no_of_wks_month)) over (partition by base.client_fee_id, base.fiscal_quarter)\n  \t\t\tend as total_weeks\n\t  \t,\tbase.fiscal_month\n\t  \t,\tbase.fiscal_quarter\n\t  \t,\tbase.frequency\n\t  \t,\tbase.recurring\n\t  \t,\tbase.client_fee_history_state\n  \t\t,\tbase.client_fee_state\n\t  \t,\tbase.invoice_id\n\t  \t,\tbase.status_id\n\t  \t,\tbase.fee_type_id\n\t  \t,\tbase.resource_id\n\t  \t,\tbase.bill_date\n\t  \t,\tmax(max(base.fiscal_month))\tover\t(partition by base.client_fee_id, base.fiscal_quarter)\tas\tlast_fmonth\n\tfrom\t$T{filter closed qtr}\tbase\n\t  \t\tleft join exploration.raw_cloudwall_order_invoice rcoi on base.invoice_id = rcoi.order_invoice_id\n\tgroup by base.client_fee_history_id, base.client_fee_id, base.invoice_number,base.fiscal_month,base.client_id,base.no_of_wks_month\n  \t\t\t ,base.fiscal_quarter,base.frequency,base.recurring, base.client_fee_history_state, base.client_fee_state, base.invoice_id, base.status_id\n  \t\t\t , base.fee_type_id, base.resource_id, base.bill_date, rcoi.order_invoice_id, base.amount\n)\n\n,cte_weekly\nas (\n\tselect\t*\n\t  \t,\ttotal_qtr_revenue\t/\ttotal_weeks\tas\tweekly_revenue_amount\n\tfrom\tcte_monthly\n)\n\n,cte_excess\nas (\n\tselect\t*\n\t\t,\tweekly_revenue_amount * weeks_month as calc_monthly_revenue_amount\n\t    ,\tcase\n\t    \t\twhen fiscal_month != last_fmonth\n\t    \t\t\tthen fee_amount - (weekly_revenue_amount * weeks_month)\n\t        \telse 0\n\t        end\tas\tfee_excess\n\tfrom\tcte_weekly\n\t\n )\n,cte_excess_2\nas (\n\tselect\t*\n\t    ,\tcase\n\t    \t\twhen fiscal_month != last_fmonth\n\t    \t\t\tthen fee_amount + coalesce(lag(fee_excess,1)over(partition by client_fee_id,fiscal_quarter order by bill_date asc),0) - (weekly_revenue_amount * weeks_month)\n\t        \telse 0\n\t        end\tas\tfee_excess_amount\n\tfrom\tcte_excess\n\t\n )\n\n\nselect \tclient_fee_history_id\n\t,\tclient_fee_id\n\t,\tinvoice_number\n\t,\tinvoice_month\n\t,\tclient_fee_id_count\n\t,\tclient_id\n\t,\tfee_amount  \t\n\t,\trevenue_amount\n\t,\testimated_wip_revenue\n\t,\ttotal_qtr_revenue\n\t,\tweeks_month\n\t,\ttotal_weeks\n\t,\tfiscal_month\n\t,\tfiscal_quarter\n\t,\tfrequency\n\t,\trecurring\n\t,\tclient_fee_history_state\n    ,\tclient_fee_state\n\t,\tinvoice_id\n\t,\tstatus_id\n\t,\tfee_type_id\n\t,\tresource_id\n\t,\tbill_date\n\t,\tlast_fmonth\n    ,\tweekly_revenue_amount\n    ,\tcalc_monthly_revenue_amount\n    ,\tfee_excess_amount\nfrom\tcte_excess_2\norder\tby\tfiscal_month,\tfiscal_quarter,\tclient_fee_history_id"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004629":{"id":2004629,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":-16,"y":256,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004618,2004619,2004620],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim date"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_date"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"date_sk"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"calendar_date"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"week_ending_sunday"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"fiscal_month"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"fiscal_quarter"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"reporting"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004630":{"id":2004630,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-1841822228,"x":608,"y":304,"width":32,"height":32,"inputConnectorIDs":[2004644,2004661,2004666],"outputConnectorIDs":[2004607],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"unite client_fee_history"}}}},"visible":true},"2":{"slot":2,"name":"Method","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"All Columns"}}}},"visible":true},"3":{"slot":3,"name":"Cast Types","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"4":{"slot":4,"name":"Add Source Component Column","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Remove duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004631":{"id":2004631,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":976,"y":448,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004601],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_market"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_market"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"market_sk"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"market_id"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"reporting"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004632":{"id":2004632,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1716658327,"x":-160,"y":176,"width":32,"height":32,"inputConnectorIDs":[2004608],"outputConnectorIDs":[2004646],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Calc closing date"}}}},"visible":true},"2":{"slot":2,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"3":{"slot":3,"name":"Calculations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DATEADD ( day, 15, \"max_week_ending_sunday\" )"},"2":{"slot":2,"type":"STRING","value":"closing_date"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"case when sysdate::date >= DATEADD ( day, 15, \"max_week_ending_sunday\" ) then true else false end"},"2":{"slot":2,"type":"STRING","value":"is_qtr_closed"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004633":{"id":2004633,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":784,"y":208,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004614],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"raw_robohead_studios_client"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"raw_robohead_studios_client"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"cw_client_id"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"exploration"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004634":{"id":2004634,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":-1760161015,"x":-224,"y":352,"width":32,"height":32,"inputConnectorIDs":[2004650],"outputConnectorIDs":[2004615],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"filter closed qtr"}}}},"visible":true},"2":{"slot":2,"name":"Filter Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"is_qtr_closed"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"true"}}}},"visible":true},"3":{"slot":3,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AND"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004635":{"id":2004635,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":-1760161015,"x":400,"y":-128,"width":32,"height":32,"inputConnectorIDs":[2004657],"outputConnectorIDs":[2004659],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Non-monthly fees"}}}},"visible":true},"2":{"slot":2,"name":"Filter Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"frequency"},"2":{"slot":2,"type":"STRING","value":"Not"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"546"}}}},"visible":true},"3":{"slot":3,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AND"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004636":{"id":2004636,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":848,"y":448,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004605],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_project"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_project"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"project_sk"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"project_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"current_record_ind"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"source_system_sk"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"engagement_id"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"reporting"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004637":{"id":2004637,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":-1760161015,"x":-224,"y":-96,"width":32,"height":32,"inputConnectorIDs":[2004604],"outputConnectorIDs":[2004640],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Monthly Recurring Fees"}}}},"visible":true},"2":{"slot":2,"name":"Filter Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"frequency"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"546"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"recurring"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"1"}}}},"visible":true},"3":{"slot":3,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AND"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004638":{"id":2004638,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-629958239,"x":880,"y":304,"width":32,"height":32,"inputConnectorIDs":[2004601,2004602,2004603,2004605,2004606,2004614,2004641,2004667,2004669,2004671],"outputConnectorIDs":[2004617],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Join"}}}},"visible":true},"2":{"slot":2,"name":"Main Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Rename 0"}}}},"visible":true},"3":{"slot":3,"name":"Main Table Alias","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cfh"}}}},"visible":true},"4":{"slot":4,"name":"Joins","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"raw_robohead_studios_project"},"2":{"slot":2,"type":"STRING","value":"rh_p"},"3":{"slot":3,"type":"STRING","value":"Left"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"raw_robohead_studios_client"},"2":{"slot":2,"type":"STRING","value":"rh_c"},"3":{"slot":3,"type":"STRING","value":"Left"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"raw_cloudwall_order_invoice"},"2":{"slot":2,"type":"STRING","value":"cw_oi"},"3":{"slot":3,"type":"STRING","value":"Left"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"dim_source_system"},"2":{"slot":2,"type":"STRING","value":"dss"},"3":{"slot":3,"type":"STRING","value":"Inner"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"dim_project"},"2":{"slot":2,"type":"STRING","value":"dp"},"3":{"slot":3,"type":"STRING","value":"Left"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"dim_client"},"2":{"slot":2,"type":"STRING","value":"dc"},"3":{"slot":3,"type":"STRING","value":"Left"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"dim_market"},"2":{"slot":2,"type":"STRING","value":"dm"},"3":{"slot":3,"type":"STRING","value":"Left"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"dim_currency"},"2":{"slot":2,"type":"STRING","value":"dcu"},"3":{"slot":3,"type":"STRING","value":"Left"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"dim_date"},"2":{"slot":2,"type":"STRING","value":"dd1"},"3":{"slot":3,"type":"STRING","value":"Left"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"dim_date"},"2":{"slot":2,"type":"STRING","value":"dd2"},"3":{"slot":3,"type":"STRING","value":"Left"}}}},"visible":true},"5":{"slot":5,"name":"Join Expressions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.client_id = rh_p.client_id\nand cfh.bill_date::date >= coalesce(rh_p.actual_start_date     ,rh_p.start_date,rh_p.original_start_date)::date\nand cfh.bill_date::date  < coalesce(rh_p.actual_completion_date,rh_p.due_date  ,rh_p.original_due_date  )::date\nand rh_p.state in (1,2,3)"},"2":{"slot":2,"type":"STRING","value":"cfh_Left_rh_p"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.client_id = rh_c.id"},"2":{"slot":2,"type":"STRING","value":"cfh_Left_rh_c"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"\"cfh\".\"invoice_id\" = \"cw_oi\".\"order_invoice_id\""},"2":{"slot":2,"type":"STRING","value":"cfh_Left_cw_oi"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"\"dss\".\"source_system_name\" = 'robohead'"},"2":{"slot":2,"type":"STRING","value":"cfh_Inner_dss"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"    \"dp\".\"project_id\" = \"rh_p\".\"id\"\nand \"dp\".\"source_system_sk\" = \"dss\".\"source_system_sk\"\nand \"dp\".\"current_record_ind\" = true"},"2":{"slot":2,"type":"STRING","value":"cfh_Left_dp"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"    \"dc\".\"source_client_id\" = \"cfh\".\"client_id\"\n/*and \"dc\".\"market_id\" = \"cw_oi\".\"market_id\" REMOVED BECAUSE 1 RECORD FOR ROBOHEAD CLIENTS IN DIM_CLIENT*/\nand \"dc\".\"source_system_sk\" = \"dss\".\"source_system_sk\"\nand \"dc\".\"current_record_ind\" = true"},"2":{"slot":2,"type":"STRING","value":"cfh_Left_dc"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"\"cw_oi\".\"market_id\" = \"dm\".\"market_id\""},"2":{"slot":2,"type":"STRING","value":"cfh_Left_dm"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"\"dcu\".\"currency_sk\" = \"dc\".\"client_currency_sk\""},"2":{"slot":2,"type":"STRING","value":"cfh_Left_dcu"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"\"cfh\".\"bill_date\"::date = \"dd1\".\"calendar_date\""},"2":{"slot":2,"type":"STRING","value":"cfh_Left_dd1"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"\"dd1\".\"week_ending_sunday\" = \"dd2\".\"calendar_date\""},"2":{"slot":2,"type":"STRING","value":"cfh_Left_dd2"}}}},"visible":true},"6":{"slot":6,"name":"Output Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.client_fee_history_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.client_fee_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.client_id"},"2":{"slot":2,"type":"STRING","value":"client_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"rh_c.cw_client_id"},"2":{"slot":2,"type":"STRING","value":"cw_client_id"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"dc.client_sk"},"2":{"slot":2,"type":"STRING","value":"client_sk"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"cw_oi.market_id"},"2":{"slot":2,"type":"STRING","value":"market_id"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"dm.market_sk"},"2":{"slot":2,"type":"STRING","value":"market_sk"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"dcu.currency_id"},"2":{"slot":2,"type":"STRING","value":"currency_id"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"dcu.exchange_rate_id"},"2":{"slot":2,"type":"STRING","value":"exchange_rate_id"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"dcu.currency_sk"},"2":{"slot":2,"type":"STRING","value":"currency_sk"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.fee_type_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_fee_type_id"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.status_id"},"2":{"slot":2,"type":"STRING","value":"revenue_status"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.bill_date"},"2":{"slot":2,"type":"STRING","value":"bill_date"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"rh_p.actual_start_date"},"2":{"slot":2,"type":"STRING","value":"project_actual_start_date"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"rh_p.start_date"},"2":{"slot":2,"type":"STRING","value":"project_start_date"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"rh_p.original_start_date"},"2":{"slot":2,"type":"STRING","value":"project_original_start_date"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"rh_p.actual_completion_date"},"2":{"slot":2,"type":"STRING","value":"project_actual_completion_date"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"rh_p.due_date"},"2":{"slot":2,"type":"STRING","value":"project_due_date"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"rh_p.original_due_date"},"2":{"slot":2,"type":"STRING","value":"project_original_due_date"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.invoice_id"},"2":{"slot":2,"type":"STRING","value":"invoice_id"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"cw_oi.order_invoice_date"},"2":{"slot":2,"type":"STRING","value":"invoice_date"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.revenue_amount"},"2":{"slot":2,"type":"STRING","value":"revenue_amount"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.estimated_wip_revenue"},"2":{"slot":2,"type":"STRING","value":"estimated_wip_revenue"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.fee_amount"},"2":{"slot":2,"type":"STRING","value":"fee_amount"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"rh_p.id"},"2":{"slot":2,"type":"STRING","value":"project_id"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"rh_p.state"},"2":{"slot":2,"type":"STRING","value":"project_state"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"dp.project_sk"},"2":{"slot":2,"type":"STRING","value":"project_sk"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"dd2.date_sk"},"2":{"slot":2,"type":"STRING","value":"approval_week_ending_sunday_sk"}}},"29":{"slot":29,"values":{"1":{"slot":1,"type":"STRING","value":"dd1.week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"approval_week_ending_sunday"}}},"30":{"slot":30,"values":{"1":{"slot":1,"type":"STRING","value":"dd2.date_sk"},"2":{"slot":2,"type":"STRING","value":"working_week_ending_sunday_sk"}}},"31":{"slot":31,"values":{"1":{"slot":1,"type":"STRING","value":"dd1.week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"working_week_ending_sunday"}}},"32":{"slot":32,"values":{"1":{"slot":1,"type":"STRING","value":"dss.source_system_sk"},"2":{"slot":2,"type":"STRING","value":"source_system_sk"}}},"33":{"slot":33,"values":{"1":{"slot":1,"type":"STRING","value":"dss.source_system_name"},"2":{"slot":2,"type":"STRING","value":"source_system_name"}}},"34":{"slot":34,"values":{"1":{"slot":1,"type":"STRING","value":"dp.engagement_id"},"2":{"slot":2,"type":"STRING","value":"engagement_id"}}},"35":{"slot":35,"values":{"1":{"slot":1,"type":"STRING","value":"rh_p.billing_type_id"},"2":{"slot":2,"type":"STRING","value":"project_billing_type_id"}}},"36":{"slot":36,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.invoice_number"},"2":{"slot":2,"type":"STRING","value":"invoice_number"}}},"37":{"slot":37,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.frequency"},"2":{"slot":2,"type":"STRING","value":"frequency"}}},"38":{"slot":38,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.recurring"},"2":{"slot":2,"type":"STRING","value":"recurring"}}},"39":{"slot":39,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.client_fee_history_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_state"}}},"40":{"slot":40,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.client_fee_state"},"2":{"slot":2,"type":"STRING","value":"client_fee_state"}}},"41":{"slot":41,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.fiscal_month"},"2":{"slot":2,"type":"STRING","value":"fiscal_month"}}},"42":{"slot":42,"values":{"1":{"slot":1,"type":"STRING","value":"cfh.fiscal_quarter"},"2":{"slot":2,"type":"STRING","value":"fiscal_quarter"}}},"43":{"slot":43,"values":{"1":{"slot":1,"type":"STRING","value":"cw_oi.order_invoice_id"},"2":{"slot":2,"type":"STRING","value":"order_invoice_id"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004639":{"id":2004639,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":704,"y":448,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004603],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_source_system"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"dim_source_system"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"source_system_sk"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"source_system_name"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"reporting"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"2004601":{"id":2004601,"sourceID":2004631,"targetID":2004638},"2004602":{"id":2004602,"sourceID":2004625,"targetID":2004638},"2004603":{"id":2004603,"sourceID":2004639,"targetID":2004638},"2004604":{"id":2004604,"sourceID":2004596,"targetID":2004637},"2004605":{"id":2004605,"sourceID":2004636,"targetID":2004638},"2004606":{"id":2004606,"sourceID":2004594,"targetID":2004638},"2004607":{"id":2004607,"sourceID":2004630,"targetID":2004625},"2004608":{"id":2004608,"sourceID":2004581,"targetID":2004632},"2004609":{"id":2004609,"sourceID":2004624,"targetID":2004583},"2004610":{"id":2004610,"sourceID":2004582,"targetID":2004585},"2004611":{"id":2004611,"sourceID":2004626,"targetID":2004585},"2004612":{"id":2004612,"sourceID":2004586,"targetID":2004593},"2004613":{"id":2004613,"sourceID":2004585,"targetID":2004590},"2004614":{"id":2004614,"sourceID":2004633,"targetID":2004638},"2004615":{"id":2004615,"sourceID":2004634,"targetID":2004628},"2004616":{"id":2004616,"sourceID":2004628,"targetID":2004622},"2004617":{"id":2004617,"sourceID":2004638,"targetID":2004578},"2004618":{"id":2004618,"sourceID":2004629,"targetID":2004624},"2004619":{"id":2004619,"sourceID":2004629,"targetID":2004581},"2004620":{"id":2004620,"sourceID":2004629,"targetID":2004584},"2004621":{"id":2004621,"sourceID":2004579,"targetID":2004588},"2004623":{"id":2004623,"sourceID":2004597,"targetID":2004589},"2004640":{"id":2004640,"sourceID":2004637,"targetID":2004580},"2004641":{"id":2004641,"sourceID":2004587,"targetID":2004638},"2004642":{"id":2004642,"sourceID":2004624,"targetID":2004622},"2004643":{"id":2004643,"sourceID":2004578,"targetID":2004577},"2004644":{"id":2004644,"sourceID":2004592,"targetID":2004630},"2004645":{"id":2004645,"sourceID":2004626,"targetID":2004586},"2004646":{"id":2004646,"sourceID":2004632,"targetID":2004580},"2004647":{"id":2004647,"sourceID":2004580,"targetID":2004582},"2004648":{"id":2004648,"sourceID":2004589,"targetID":2004588},"2004649":{"id":2004649,"sourceID":2004584,"targetID":2004626},"2004650":{"id":2004650,"sourceID":2004580,"targetID":2004634},"2004656":{"id":2004656,"sourceID":2004585,"targetID":2004627},"2004657":{"id":2004657,"sourceID":2004596,"targetID":2004635},"2004658":{"id":2004658,"sourceID":2004588,"targetID":2004599},"2004659":{"id":2004659,"sourceID":2004635,"targetID":2004589},"2004660":{"id":2004660,"sourceID":2004593,"targetID":2004583},"2004661":{"id":2004661,"sourceID":2004591,"targetID":2004630},"2004662":{"id":2004662,"sourceID":2004596,"targetID":2004597},"2004663":{"id":2004663,"sourceID":2004622,"targetID":2004591},"2004664":{"id":2004664,"sourceID":2004590,"targetID":2004586},"2004665":{"id":2004665,"sourceID":2004584,"targetID":2004580},"2004666":{"id":2004666,"sourceID":2004599,"targetID":2004630},"2004667":{"id":2004667,"sourceID":2004579,"targetID":2004638},"2004668":{"id":2004668,"sourceID":2004627,"targetID":2004586},"2004669":{"id":2004669,"sourceID":2004595,"targetID":2004638},"2004670":{"id":2004670,"sourceID":2004583,"targetID":2004592},"2004671":{"id":2004671,"sourceID":2004576,"targetID":2004638}},"notes":{"2004551":{"id":2004551,"x":1149,"y":389,"width":339,"height":173,"text":"--TESTING\n\n-- apportionment validation\nwith stg as (\n     select client_fee_history_id, sum(app_amount) as amt\n     from staging.stg1_robohead_studios_fact_financial_metrics_client_fees_service\n     group by client_fee_history_id\n     )\n,src as (\n    select id,amount::numeric(30,8) as amt\n    from exploration.raw_robohead_studios_client_fee_history\n    where fee_type_id = 540\n      and status_id = 509\n)\nselect *, src.amt-stg.amt as diff\nfrom src\nfull join stg on stg.client_fee_history_id = src.id\nwhere src.amt-stg.amt not between  -1 and 1;\n\n\n-- granularity validation\nselect project_id,client_fee_history_id\nfrom staging.stg1_robohead_studios_fact_financial_metrics_client_fees_service\ngroup by project_id,client_fee_history_id\nhaving count(*)>1;","colour":"e6e63c"},"2004598":{"id":2004598,"x":758,"y":258,"width":250,"height":58,"text":"temporarily added filters to join bill date between project start & end AND project state 1,2,3","colour":"e6e63c"},"2004600":{"id":2004600,"x":-22,"y":406,"width":250,"height":58,"text":"ADM-1210:\n- created new lines for revenue overflows to the next fiscal month.","colour":"e6e63c"}},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"stage1_robohead_studios_fact_financial_metrics_client_fees_service_rewrite","description":"","type":"TRANSFORMATION","tag":"25700974-3a14-4460-87c3-1b6dd10b8455"}}