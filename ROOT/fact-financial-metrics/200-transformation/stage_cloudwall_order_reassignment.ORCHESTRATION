{"job":{"components":{"2004970":{"id":2004970,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":1248,"y":0,"width":32,"height":32,"inputConnectorIDs":[2004969],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert stg3_cloudwall_order_reassignment to stg1_cloudwall_fact_financial_metrics"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into staging.stg1_cloudwall_fact_financial_metrics(\n${jv_columns}\n)\nselect\n${jv_columns}\nfrom staging.stg3_cloudwall_order_reassignment\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2004972":{"id":2004972,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":960,"y":0,"width":32,"height":32,"inputConnectorIDs":[2004971],"outputSuccessConnectorIDs":[2004967],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"remove missing order records from stg1_cloudwall_fact_financial_metrics"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"delete from staging.stg1_cloudwall_fact_financial_metrics\nwhere exists (select 1 from staging.stg3_cloudwall_order_reassignment cor\n              where cor.or__employee_person_id          = staging.stg1_cloudwall_fact_financial_metrics.employee_person_id \n                and cor.or__approval_week_ending_sunday = staging.stg1_cloudwall_fact_financial_metrics.approval_week_ending_sunday\n                and coalesce(staging.stg1_cloudwall_fact_financial_metrics.order_id,0) = 0\n             )\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2004973":{"id":2004973,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":1168,"y":0,"width":32,"height":32,"inputConnectorIDs":[2004967],"outputSuccessConnectorIDs":[2004969],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Get stg column names"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"qry = \"\"\"\nselect column_name\nfrom information_schema.columns\nwhere table_schema = 'staging'\n  and table_name   = 'stg1_cloudwall_fact_financial_metrics'\norder by ordinal_position\n\"\"\"\n\ncursor = context.cursor()\ncursor.execute(qry)\n\nrows = cursor.fetchall()\ncols = ','.join([x[0] for x in rows])\nprint(cols)\n\ncontext.updateVariable('jv_columns',cols)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2004974":{"id":2004974,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":432,"y":0,"width":32,"height":32,"inputConnectorIDs":[2004966],"outputSuccessConnectorIDs":[2004968],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rewrite stg2_cloudwall_order_reassignment"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"  drop table if exists staging.stg2_cloudwall_order_reassignment;\ncreate table           staging.stg2_cloudwall_order_reassignment as\n\nselect \n     cor.employee_person_id           as or__employee_person_id\n    ,cor.approval_week_ending_sunday  as or__approval_week_ending_sunday\n    ,cor.or__order_id\n    ,rdo.order_sk\t\t\t\t\t  as or__order_sk\n    ,rdo.client_sk \t\t\t\t\t  as or__client_sk\n    ,rdo.client_id \t\t\t\t\t  as or__client_id\n    ,rdo.market_sk \t\t\t\t\t  as or__market_sk\n    ,rdo.market_id \t\t\t\t\t  as or__market_id\n    ,rdcu.currency_sk \t\t\t\t  as or__currency_sk\n    ,rdcu.currency_id \t\t\t\t  as or__currency_id\n    ,rdcu.exchange_rate_id  \t\t  as or__exchange_rate_id\nfrom staging.stg1_cloudwall_order_reassignment cor\nleft join reporting.dim_order rdo on rdo.order_id = cor.or__order_id \n                                 and rdo.current_record_ind=true \n                                 and rdo.isdeleted=false\nleft join reporting.dim_market rdm on rdm.market_id = rdo.market_id\nleft join reporting.dim_currency rdcu on rdcu.currency_id = rdm.market_currency_id\n                                     and cor.approval_week_ending_sunday::date <  rdcu.exchange_rate_end_date\n                                     and cor.approval_week_ending_sunday::date >= rdcu.exchange_rate_start_date\n                                     and rdcu.current_record_ind = true\n                                     and rdcu.isdeleted = false\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2004975":{"id":2004975,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":704,"y":0,"width":32,"height":32,"inputConnectorIDs":[2004968],"outputSuccessConnectorIDs":[2004971],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage3_cloudwall_order_reassignment_rewrite"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage3_cloudwall_order_reassignment_rewrite"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2004976":{"id":2004976,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2004964],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2004977":{"id":2004977,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":160,"y":0,"width":32,"height":32,"inputConnectorIDs":[2004964],"outputSuccessConnectorIDs":[2004966],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rewrite stg1_cloudwall_order_reassignment"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"  drop table if exists staging.stg1_cloudwall_order_reassignment;\ncreate table           staging.stg1_cloudwall_order_reassignment as\n\nwith\n missing_orders as ( --records with valid emp/approval_wes but no order\n    select distinct\n        employee_person_id,approval_week_ending_sunday\n    from staging.stg1_cloudwall_fact_financial_metrics \n    where coalesce(order_id,0) = 0\n      and employee_person_id <> 0\n      and approval_week_ending_sunday <> '1901-01-01'\n)\n,valid_orders as ( --records with valid emp/approval_wes/order\n    select distinct\n        employee_person_id,approval_week_ending_sunday,order_id\n    from staging.stg1_cloudwall_fact_financial_metrics\n    where order_id <> 0\n      and employee_person_id <> 0\n      and approval_week_ending_sunday <> '1901-01-01'\n)\n\n,valid_orders__same as ( --records with valid emp/approval_wes/order in the same week as the missing order record\n    select \n         employee_person_id\n        ,approval_week_ending_sunday\n        ,SPLIT_TO_ARRAY(listagg(order_id,','),',') as order_id__same\n    from valid_orders\n    group by 1,2\n)\n\n,valid_orders__prev as ( --records with valid emp/approval_wes/order in the nearest previous week as the missing order record\n    select \n         employee_person_id\n        ,approval_week_ending_sunday\n        ,approval_week_ending_sunday__prev\n        ,SPLIT_TO_ARRAY(listagg(order_id,','),',') as order_id__prev\n    from (  \n            select \n                 mo.employee_person_id\n                ,mo.approval_week_ending_sunday\n                ,vo.approval_week_ending_sunday as approval_week_ending_sunday__prev\n                ,vo.order_id\n                ,dense_rank() over(partition by mo.employee_person_id,mo.approval_week_ending_sunday order by vo.approval_week_ending_sunday desc) rnk\n            from missing_orders mo\n            left join valid_orders vo on vo.employee_person_id = mo.employee_person_id\n            where vo.approval_week_ending_sunday < mo.approval_week_ending_sunday\n         )\n    where rnk = 1\n    group by 1,2,3\n)\n\n,valid_orders__late as ( --records with valid emp/approval_wes/order in the nearest later week as the missing order record\n    select \n         employee_person_id\n        ,approval_week_ending_sunday\n        ,approval_week_ending_sunday__late\n        ,SPLIT_TO_ARRAY(listagg(order_id,','),',') as order_id__late\n    from (  \n            select \n                 mo.employee_person_id\n                ,mo.approval_week_ending_sunday\n                ,vo.approval_week_ending_sunday as approval_week_ending_sunday__late\n                ,vo.order_id\n                ,dense_rank() over(partition by mo.employee_person_id,mo.approval_week_ending_sunday order by vo.approval_week_ending_sunday asc) rnk\n            from missing_orders mo\n            left join valid_orders vo on vo.employee_person_id = mo.employee_person_id\n            where vo.approval_week_ending_sunday > mo.approval_week_ending_sunday\n         )\n    where rnk = 1\n    group by 1,2,3\n)\n\n,cte as ( --apply precedence rules to consolidate\n    select \n         mo.*\n        ,coalesce(order_id__same,order_id__prev,order_id__late) as order_id__new\n        ,order_id__same,order_id__prev,order_id__late\n    from missing_orders mo\n    left join valid_orders__same same on same.employee_person_id = mo.employee_person_id and same.approval_week_ending_sunday = mo.approval_week_ending_sunday\n    left join valid_orders__prev prev on prev.employee_person_id = mo.employee_person_id and prev.approval_week_ending_sunday = mo.approval_week_ending_sunday\n    left join valid_orders__late late on late.employee_person_id = mo.employee_person_id and late.approval_week_ending_sunday = mo.approval_week_ending_sunday    \n)\n\n--unpivot and present result\nselect employee_person_id,approval_week_ending_sunday,or__order_id::int\nfrom cte as c\nleft join c.order_id__new as or__order_id on true\nwhere or__order_id is not null\n;\n\n/* \nResult testing/confirmation\n\n    select distinct\n        employee_person_id,approval_week_ending_sunday,order_id\n    from staging.stg1_cloudwall_fact_financial_metrics\n    where employee_person_id = 3345889\n    order by 1,2 desc,3\n    ;\n\n*/"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2004966":{"id":2004966,"sourceID":2004977,"targetID":2004974},"2004967":{"id":2004967,"sourceID":2004972,"targetID":2004973},"2004968":{"id":2004968,"sourceID":2004974,"targetID":2004975},"2004969":{"id":2004969,"sourceID":2004973,"targetID":2004970},"2004971":{"id":2004971,"sourceID":2004975,"targetID":2004972}},"failureConnectors":{},"unconditionalConnectors":{"2004964":{"id":2004964,"sourceID":2004976,"targetID":2004977}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{"2004978":{"id":2004978,"x":581,"y":-50,"width":249,"height":110,"text":"Apply order reassignment, creating replacement records","colour":"e6e63c"},"2004979":{"id":2004979,"x":856,"y":-50,"width":492,"height":124,"text":"Replace missing order records with reassigned order records","colour":"e6e63c"},"2004980":{"id":2004980,"x":38,"y":-160,"width":253,"height":219,"text":"identify emp/approval_wes records without a valid order_id, then find the nearest valid order_id(s) for the emp.\n\n**``Precedence``**\n\n1. Order(s) in same approval_wes\n2. Order(s) in a previous approval_wes\n2. Order(s) in a later approval_wes","colour":"e6e63c"},"2004981":{"id":2004981,"x":332,"y":-52,"width":205,"height":110,"text":"Lookup reassigned order fields","colour":"e6e63c"}},"variables":{"jv_columns":{"definition":{"name":"jv_columns","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PRIVATE"},"value":""}},"grids":{"gv_columns":{"definition":{"name":"gv_columns","scope":"TASKBATCH","definitions":[{"name":"col_name","type":"TEXT"}],"description":"","visibility":"PUBLIC"},"values":[]}}},"info":{"name":"stage_cloudwall_order_reassignment","description":"","type":"ORCHESTRATION","tag":"722b1bed-794a-42b0-9dbc-da7f59fd1b99"}}