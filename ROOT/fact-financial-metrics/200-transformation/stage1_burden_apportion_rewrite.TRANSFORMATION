{"job":{"components":{"2004214":{"id":2004214,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1716658327,"x":689,"y":66,"width":32,"height":32,"inputConnectorIDs":[2004213],"outputConnectorIDs":[2004210],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"set defaults"}}}},"visible":true},"2":{"slot":2,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"3":{"slot":3,"name":"Calculations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"nvl(\"timeslip_id\", 0)"},"2":{"slot":2,"type":"STRING","value":"timeslip_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"nvl(\"employee_person_id\", 0)"},"2":{"slot":2,"type":"STRING","value":"employee_person_id"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"nvl(\"project_id\", 0)"},"2":{"slot":2,"type":"STRING","value":"project_id"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"nvl(\"fee_code_id\", 0)"},"2":{"slot":2,"type":"STRING","value":"fee_code_id"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"nvl(\"project_fee_history_id\",0)"},"2":{"slot":2,"type":"STRING","value":"project_fee_history_id"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"nvl(\"client_fee_history_id\",0)"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"nvl(\"client_id\", 0)"},"2":{"slot":2,"type":"STRING","value":"client_id"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004216":{"id":2004216,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-1841822228,"x":528,"y":64,"width":32,"height":32,"inputConnectorIDs":[2004208,2004211],"outputConnectorIDs":[2004213],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Unite cw & rh"}}}},"visible":true},"2":{"slot":2,"name":"Method","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"All Columns"}}}},"visible":true},"3":{"slot":3,"name":"Cast Types","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"4":{"slot":4,"name":"Add Source Component Column","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Remove duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004217":{"id":2004217,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":368,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004211],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cloudwall"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select \n\t case \n    \t when timecard_id         <> 0 then source_system || '*' || source_table || '*' || timecard_id         || '*' || coalesce(order_id,0) || '*' || coalesce(fee_code_id,0)  || '*' || coalesce(approval_week_ending_sunday,'1901-01-01') || '*' || coalesce(working_week_ending_sunday,'1901-01-01')\n         when business_expense_id <> 0 then source_system || '*' || source_table || '*' || business_expense_id || '*' || coalesce(order_id,0) || '*' || coalesce(fee_code_id,0)  || '*' || coalesce(approval_week_ending_sunday,'1901-01-01') || '*' || coalesce(working_week_ending_sunday,'1901-01-01')\n     end as srckey\n    ,employee_person_id\n    ,approval_week_ending_sunday\n    ,coalesce(timecard_regular_hours,hour_adjustment,0) as hours\n    ,case \n    \t when cost_amount <> 0 then cost_amount \n         else (coalesce(timecard_regular_hours    ,0) * coalesce(timecard_pay_rate         ,0)) + \n              (coalesce(timecard_overtime_hours   ,0) * coalesce(timecard_overtime_pay_rate,0)) +\n              (coalesce(timecard_double_time_hours,0) * coalesce(timecard_other_pay_rate   ,0)) \n     end as cost\n\n    ,fee_code_id\n    ,case \n    \t when working_week_ending_sunday < approval_week_ending_sunday \n         \t then true \n     end as is_backdated\n\nfrom staging.stg1_cloudwall_fact_financial_metrics stg"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004218":{"id":2004218,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":848,"y":64,"width":32,"height":32,"inputConnectorIDs":[2004210],"outputConnectorIDs":[2004215],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"emp/week has actual cost"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select \n\t  listagg(distinct split_part(srckey,'*',1),',') \n\t    within group (order by split_part(srckey,'*',1)) \n        over (partition by employee_person_id,approval_week_ending_sunday)\n      as sources\n     ,listagg(distinct split_part(srckey,'*',2),',') \n\t    within group (order by split_part(srckey,'*',2)) \n        over (partition by employee_person_id,approval_week_ending_sunday)\n      as financial_types\n     ,(max(case when fin.is_staff_salaried = true then 1 end) over (partition by employee_person_id,approval_week_ending_sunday))::boolean\tas\tis_staff_salaried_group\n     ,fin.*\nfrom $T{set defaults} fin\nwhere exists (select 1 from staging.stg1_burden_fact_financial_metrics act\n              where act.employee_person_id          = fin.employee_person_id\n                and act.approval_week_ending_sunday = fin.approval_week_ending_sunday\n             )"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004219":{"id":2004219,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":335239555,"x":1104,"y":64,"width":32,"height":32,"inputConnectorIDs":[2004212],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stg1_burden_apportion"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stg1_burden_apportion"}}}},"visible":true},"3":{"slot":3,"name":"Table Sort Key","elements":{},"visible":true},"4":{"slot":4,"name":"Table Distribution Style","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Even"}}}},"visible":true},"5":{"slot":5,"name":"Table Distribution Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":null}}}},"visible":false},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"staging"}}}},"visible":true},"7":{"slot":7,"name":"Sort Key Options","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Compound"}}}},"visible":false}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004220":{"id":2004220,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":368,"y":112,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004208],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"robohead"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with dim_employee\n as (\n\tselect *,rank()over(partition by cloudwall_talent_id order by effective_start_date desc,employment_status_id asc) as rank_num\n    from reporting.dim_employee where current_record_ind  = true\n)\n, robohead_project_fees_aggregate\n as (\n    select  timeslip_id\n          , project_fee_history_id\n          , employee_person_id\n          , approval_week_ending_sunday\n     \t  , max(timecard_pay_rate)\t            \tas pay_rate\n          , max(timecard_regular_hours)          \tas hours\n     \t  , (pay_rate / count(1))::numeric(21,4)\tas\tapp_pay_rate\n     \t  , (hours / count(1))::numeric(21,4)\t    as\tapp_hours\n     from staging.stg2_robohead_studios_fact_financial_metrics_project_fees\n     group by employee_person_id\n            , approval_week_ending_sunday\n            , timeslip_id\n            , project_fee_history_id\n    )\n, robohead_sources_unite\n as (\n\tselect source_system || '*' || source_table || '*' || working_week_ending_sunday::date || '*' ||\n\t       timeslip_id || '*' || cloudwall_fee_adjustment_id || '*' || project_id || '*' || client_id\tas srckey\n         , timeslip_id\n         , employee_person_id\n         , approval_week_ending_sunday::date\n    \t , working_week_ending_sunday::date\n    \t , nvl(timecard_pay_rate, 0.00) * timecard_regular_hours * nvl(cost_apportionment,1.00)\tas cost\n         , timecard_regular_hours                                              \t\t\t\t\tas hours\n         , project_id\n   \t\t , client_id\n         , 0::int as project_fee_history_id\n         , 0::int as client_fee_history_id\n    from staging.stg2_robohead_studios_fact_financial_metrics_timeslips ts\n    union all\n    select source_system || '*' || source_table || '*' || client_fee_history_id || '*' ||  client_fee_id || '*' ||\n   \t\t   project_id || '*' || working_week_ending_sunday || '*' || timesheet_id || '*' || timeslip_id as srckey\n         , timeslip_id\n         , employee_person_id\n         , approval_week_ending_sunday\n    \t , working_week_ending_sunday\n    \t , nvl(timecard_pay_rate, 0.00) * (sum_timeslip_hours / 60.0)\t\t\t\t\t  as cost\n         , sum_timeslip_hours / 60.0                                                      as hours\n         , project_id\n   \t\t , client_id\n         , 0::int as project_fee_history_id\n         , client_fee_history_id\n    from staging.stg2_robohead_studios_fact_financial_metrics_client_fees_fixed_resource\n    union all\n    select pf.source_system || '*' || pf.source_table || '*' || pf.project_fee_history_id || '*' ||\n   \t\t   pf.project_fee_id || '*' || pf.working_week_ending_sunday || '*' || pf.timeslip_id as srckey\n         , pf.timeslip_id\n         , pf.employee_person_id\n         , pf.approval_week_ending_sunday\n    \t , pf.working_week_ending_sunday\n    \t , (cte.app_pay_rate\t* cte.app_hours)::numeric(21,4)\t            as\tcost\n     \t , cte.app_hours::numeric(21,4)\t                                    as\thours\n         , pf.project_id\n   \t\t , pf.client_id\n         , pf.project_fee_history_id\n         , 0::int as client_fee_history_id\n    from staging.stg2_robohead_studios_fact_financial_metrics_project_fees pf\n    \tinner join robohead_project_fees_aggregate cte\n    \t\ton  pf.timeslip_id                  = cte.timeslip_id\n    \t\tand pf.employee_person_id           = cte.employee_person_id\n    \t\tand pf.approval_week_ending_sunday  = cte.approval_week_ending_sunday\n    \t\tand pf.project_fee_history_id       = cte.project_fee_history_id\n    )\n\nselect distinct\n\t   cte.*\n     , de.employee_id\n     , case when de.staff = true and de.paygroup_desc ilike '%salary' then true end as is_staff_salaried\n     ,case\n    \t when working_week_ending_sunday < approval_week_ending_sunday\n         \t then true\n     end as is_backdated\nfrom robohead_sources_unite cte\n    left join dim_employee\tde\n        on\tcte.employee_person_id\t=\tde.cloudwall_talent_id\n        and\tde.current_record_ind = true\n        and\tde.rank_num = 1"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004221":{"id":2004221,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":128170095,"x":976,"y":64,"width":32,"height":32,"inputConnectorIDs":[2004215],"outputConnectorIDs":[2004212],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop columns"}}}},"visible":true},"2":{"slot":2,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"sources"},"2":{"slot":2,"type":"STRING","value":"sources"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"financial_types"},"2":{"slot":2,"type":"STRING","value":"financial_types"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"srckey"},"2":{"slot":2,"type":"STRING","value":"srckey"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"employee_person_id"},"2":{"slot":2,"type":"STRING","value":"employee_person_id"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"approval_week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"approval_week_ending_sunday"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"hours"},"2":{"slot":2,"type":"STRING","value":"hours"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"cost"},"2":{"slot":2,"type":"STRING","value":"cost"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"fee_code_id"},"2":{"slot":2,"type":"STRING","value":"fee_code_id"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"is_backdated"},"2":{"slot":2,"type":"STRING","value":"is_backdated"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"timeslip_id"},"2":{"slot":2,"type":"STRING","value":"timeslip_id"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"working_week_ending_sunday"},"2":{"slot":2,"type":"STRING","value":"working_week_ending_sunday"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"project_id"},"2":{"slot":2,"type":"STRING","value":"project_id"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"is_staff_salaried_group"},"2":{"slot":2,"type":"STRING","value":"is_staff_salaried"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"project_fee_history_id"},"2":{"slot":2,"type":"STRING","value":"project_fee_history_id"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"client_fee_history_id"},"2":{"slot":2,"type":"STRING","value":"client_fee_history_id"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"client_id"},"2":{"slot":2,"type":"STRING","value":"client_id"}}}},"visible":true},"3":{"slot":3,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"2004208":{"id":2004208,"sourceID":2004220,"targetID":2004216},"2004210":{"id":2004210,"sourceID":2004214,"targetID":2004218},"2004211":{"id":2004211,"sourceID":2004217,"targetID":2004216},"2004212":{"id":2004212,"sourceID":2004221,"targetID":2004219},"2004213":{"id":2004213,"sourceID":2004216,"targetID":2004214},"2004215":{"id":2004215,"sourceID":2004218,"targetID":2004221}},"notes":{},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"stage1_burden_apportion_rewrite","description":"","type":"TRANSFORMATION","tag":"2f7d84ed-664a-4486-9bd6-a7790006c52d"}}