{"job":{"components":{"2004802":{"id":2004802,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":784,"y":400,"width":32,"height":32,"inputConnectorIDs":[2004803],"outputConnectorIDs":[2004801],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Get SKs"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with dim_employee\nas (\n\tselect *,rank()over(partition by cloudwall_talent_id order by effective_start_date desc,employment_status_id asc) as rank_num\n    from reporting.dim_employee where current_record_ind  = true\n)\n\nselect\n\n   ts.*\n  ,dj.engagement_id\n\n  ,coalesce(awes.date_sk,-1) as approval_week_ending_sunday_sk\n  ,coalesce(wwes.date_sk,-1) as working_week_ending_sunday_sk\n  ,coalesce(iwes.date_sk,-1) as invoice_week_ending_sunday_sk\n  ,coalesce(dss.source_system_sk,-1) as source_system_sk\n  ,coalesce(dss.source_system_name,'Default') as source_system\n  ,coalesce(dm.market_sk,-1) as market_sk\n  ,coalesce(dc.client_sk,-1) as cw_client_sk\n  ,coalesce(dcu.currency_sk,-1) as currency_sk\n  ,coalesce(dj.project_sk,-1)  as project_sk\n  ,coalesce(de.employee_sk,-1) as employee_sk\n\nfrom $T{cw timeslips} ts\nleft join reporting.dim_date awes on awes.calendar_date = ts.approval_week_ending_sunday::date\nleft join reporting.dim_date wwes on wwes.calendar_date = ts.working_week_ending_sunday::date\nleft join reporting.dim_date iwes on iwes.calendar_date = ts.invoice_week_ending_sunday::date\nleft join reporting.dim_source_system dss on dss.source_system_name = 'cloudwall'\nleft join reporting.dim_market dm on dm.market_id = ts.market_id\nleft join reporting.dim_client dc on dc.source_client_id   = ts.cw_client_id \n\t\t\t\t\t\t\t\t and dc.market_id          = ts.market_id \n                                 and dc.source_system      = dss.source_system_name \n                                 and dc.current_record_ind = true \n                                 and dc.isdeleted          = false\nleft join reporting.dim_currency dcu on dcu.currency_id        = ts.currency_id \n\t\t\t\t\t\t\t\t\tand dcu.exchange_rate_id   = ts.currency_exchange_rate_id \n                                    and dcu.source_system      = dss.source_system_name \n                                    and dcu.current_record_ind = true \n                                    and dcu.isdeleted          = false\nleft join reporting.dim_project dj on dj.project_id         = ts.rh_project_id\n\t\t\t\t\t\t\t\t  and dj.current_record_ind = true \n                                  and dj.isdeleted          = false\nleft join dim_employee de \t\t\ton de.cloudwall_talent_id = ts.employee_person_id \n\t\t\t\t\t\t\t\t   and de.current_record_ind  = true\n\t\t\t\t\t\t\t\t   and de.rank_num = 1\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004804":{"id":2004804,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":512,"y":400,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[2004803],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cw timeslips"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select\n    ta.timeslipo_adjustment_id as cloudwall_fee_adjustment_id\n   ,ta.timeslip_id as cw_timeslip_id\n   ,ts.external_timeslip_id as rh_timeslip_id\n   ,ta.timeslip_adjustment_type_id cloudwall_fee_adjustment_type_id\n   ,d.week_ending_sunday as approval_week_ending_sunday\n   ,ta.week_ending_sunday as working_week_ending_sunday\n   ,round(ta.duration/60.0, 2) as hours\n   ,ta.bill_rate\n   ,round(round(ta.duration/60.0, 2)*ta.bill_rate,2) as bill_amount\n   ,jt2.employee_pay_rate\tas\tpay_rate\n   ,oi.order_invoice_id\n--adm-1160-bug-fix\n   --,jt1.emp_person_id as employee_person_id\n   ,rhuser.cw_user_id\tas employee_person_id\n--adm-1160-bug-fix\n   ,coalesce(ts.project_id,0) as cw_project_id\n   ,coalesce(rhp.id,0) as rh_project_id\n   ,oi.order_invoice_date\n   ,inv.week_ending_sunday as invoice_week_ending_sunday\n   ,ts.client_id as cw_client_id\n   ,oi.invoice_number\n   ,rhp.billing_type_id\n   ,jt1.market_id\n   ,cwco.currency_id\n   ,cwex.currency_exchange_rate_id\n\nfrom exploration.raw_cloudwall_timeslip ts\ninner join exploration.raw_cloudwall_timeslip_adjustment ta on ta.timeslip_id = ts.timeslip_id\ninner join exploration.raw_cloudwall_order_invoice oi on oi.order_invoice_id = ta.order_invoice_id \nleft join exploration.raw_cloudwall_job_time_card3 jt3 on jt3.time_card_id = ts.time_card_id\nleft join exploration.raw_cloudwall_job_time_card1 jt1 on jt1.time_card_id = ts.time_card_id\nleft join exploration.raw_cloudwall_job_time_card2 jt2 on jt2.time_card_id = jt1.time_card_id\nleft join exploration.raw_cloudwall_adp_batch adp on adp.adp_batch_id = jt3.adp_batch_id\ninner join reporting.dim_date d on d.calendar_date =\n      case\n          when ta.timeslip_adjustment_type_id in (1, 2)\n              then adp.week_ending_sunday::date\n          else ta.adjustment_date::date \n      end\n\nleft join reporting.dim_date inv on inv.calendar_date = oi.order_invoice_date::date\nleft join exploration.raw_cloudwall_project cwp on cwp.project_id = ts.project_id\nleft join exploration.raw_robohead_studios_project rhp on rhp.id = cwp.external_project_id\nleft join exploration.raw_cloudwall_market cwm on cwm.market_id = jt1.market_id\nleft join exploration.raw_cloudwall_country cwco on cwco.country_id = cwm.country_id\nleft join exploration.raw_cloudwall_currency_exchange_rate cwex on cwex.currency_id = cwco.currency_id\n                                                               and jt1.week_ending_sunday >= cwex.start_date \n                                                               and jt1.week_ending_sunday <  cwex.end_date\n--adm-1160-bug-fix\nleft join exploration.raw_robohead_studios_timeslip rhts on\tts.external_timeslip_id = rhts.id\nleft join exploration.raw_robohead_studios_user rhuser on rhts.user_id = rhuser.id\n--adm-1160-bug-fix\nwhere ta.timeslip_adjustment_type_id in (1, 2, 3, 4)\n  and ta.invoice = true\n  and oi.invoice_status > 3\n  and jt1.order_id is not null"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"2004805":{"id":2004805,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":335239555,"x":1056,"y":400,"width":32,"height":32,"inputConnectorIDs":[2004801],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Rewrite stg1_robohead_studios_fact_financial_metrics_timeslips"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stg1_robohead_studios_fact_financial_metrics_timeslips"}}}},"visible":true},"3":{"slot":3,"name":"Table Sort Key","elements":{},"visible":true},"4":{"slot":4,"name":"Table Distribution Style","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Even"}}}},"visible":true},"5":{"slot":5,"name":"Table Distribution Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"staging"}}}},"visible":true},"7":{"slot":7,"name":"Sort Key Options","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Compound"}}}},"visible":false}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"2004801":{"id":2004801,"sourceID":2004802,"targetID":2004805},"2004803":{"id":2004803,"sourceID":2004804,"targetID":2004802}},"notes":{"2004807":{"id":2004807,"x":694,"y":449,"width":191,"height":93,"text":"dim_employee join causing dupes\n\nselect * from reporting.dim_employee\nwhere cloudwall_talent_id = 2488388\n  and current_record_ind = true;","colour":"e6e63c"}},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"stage1_robohead_studios_fact_financial_metrics_timeslips_rewrite","description":"","type":"TRANSFORMATION","tag":"eb794485-3ada-4caf-b371-2278b1146211"}}